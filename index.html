<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema Financeiro Pessoal - Vers√£o Completa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* CONFIGURA√á√ÉO */
.config-section {
  background: #fff3cd;
  border: 2px solid #ffc107;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
}

.config-section h3 {
  color: #856404;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.config-section input {
  width: 100%;
  padding: 10px;
  border: 2px solid #ffc107;
  border-radius: 6px;
  font-size: 13px;
  font-family: monospace;
}

.config-section button {
  margin-top: 10px;
  background: #ffc107;
  color: #000;
  font-weight: 600;
}

.config-section button:hover {
  background: #e0a800;
}

.config-section small {
  display: block;
  margin-top: 8px;
  color: #856404;
  font-size: 12px;
}

/* TELA DE LOGIN */
.login-container {
  background: #fff;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  width: 90%;
  max-width: 400px;
}

.login-container h2 {
  text-align: center;
  color: #667eea;
  margin-bottom: 30px;
  font-size: 28px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-weight: 600;
}

.form-group input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 14px;
  transition: border-color 0.3s;
}

.form-group input:focus {
  outline: none;
  border-color: #667eea;
}

.btn-entrar {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}

.btn-entrar:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

/* TELA PRINCIPAL */
.main-container {
  display: none;
  width: 100%;
  min-height: 100vh;
  background: #f4f6f9;
}

.main-container.active {
  display: block;
}

.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  padding: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header h1 {
  font-size: 24px;
}

.user-info {
  text-align: right;
}

.user-name {
  font-weight: 600;
  font-size: 16px;
}

.btn-sair {
  background: rgba(255,255,255,0.2);
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 5px;
  font-size: 14px;
}

.btn-sair:hover {
  background: rgba(255,255,255,0.3);
}

/* CARDS PRINCIPAIS */
.cards-container {
  max-width: 1200px;
  margin: 40px auto;
  padding: 20px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
}

.main-card {
  background: #fff;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: transform 0.3s, box-shadow 0.3s;
  text-align: center;
}

.main-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.main-card .icon {
  font-size: 48px;
  margin-bottom: 15px;
}

.main-card h3 {
  color: #333;
  font-size: 20px;
  margin-bottom: 10px;
}

.main-card p {
  color: #666;
  font-size: 14px;
}

/* TELA DE M√ìDULO */
.module-container {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  overflow-y: auto;
}

.module-container.active {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 20px;
}

.module-content {
  background: #fff;
  border-radius: 12px;
  max-width: 1200px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  margin-top: 20px;
}

.module-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  padding: 20px;
  border-radius: 12px 12px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 10;
}

.module-header h2 {
  font-size: 24px;
}

.btn-close {
  background: rgba(255,255,255,0.2);
  border: none;
  color: #fff;
  font-size: 24px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-close:hover {
  background: rgba(255,255,255,0.3);
}

.module-body {
  padding: 20px;
}

/* RESUMOS POR CATEGORIA */
.summary-section {
  margin-bottom: 30px;
}

.summary-section h3 {
  color: #333;
  margin-bottom: 15px;
  font-size: 18px;
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 15px;
}

.summary-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.summary-card h4 {
  font-size: 14px;
  margin-bottom: 10px;
  opacity: 0.9;
  font-weight: 600;
}

.summary-card p {
  font-size: 24px;
  font-weight: 700;
}

.summary-card.highlight {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.summary-card.danger {
  background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
}

.summary-card.warning {
  background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
}

.recurrence-info {
  background: rgba(255,255,255,0.2);
  padding: 8px;
  border-radius: 4px;
  margin-top: 10px;
  font-size: 11px;
  font-style: italic;
}

/* FORMUL√ÅRIOS */
.form-card {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  border: 2px solid #e0e0e0;
  transition: all 0.3s;
}

.form-card.editing {
  border-color: #667eea;
  background: #f0f4ff;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
}

.form-card h3 {
  color: #333;
  margin-bottom: 15px;
  font-size: 18px;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 15px;
}

.form-group-inline {
  display: flex;
  flex-direction: column;
}

.form-group-inline label {
  font-weight: 600;
  color: #333;
  margin-bottom: 5px;
  font-size: 13px;
}

input, select, textarea {
  width: 100%;
  padding: 10px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  font-size: 14px;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #667eea;
}

.action-buttons {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  border: none;
  padding: 12px 24px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
}

.btn-primary:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

.btn-secondary {
  background: #6c757d;
  color: #fff;
  border: none;
  padding: 12px 24px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
}

.btn-secondary:hover {
  background: #5a6268;
}

.btn-export {
  background: #17a2b8;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
}

.btn-export:hover {
  background: #138496;
}

.btn-success {
  background: #28a745;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
}

.btn-success:hover {
  background: #218838;
}

/* TABELAS */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: #fff;
}

table th, table td {
  border: 1px solid #ddd;
  padding: 12px;
  text-align: left;
}

table th {
  background: #f8f9fa;
  font-weight: 600;
  color: #333;
  cursor: pointer;
  user-select: none;
  position: relative;
  padding-right: 25px;
}

table th:hover {
  background: #e9ecef;
}

table th.sortable::after {
  content: '‚áÖ';
  position: absolute;
  right: 8px;
  opacity: 0.3;
  font-size: 12px;
}

table th.sorted-asc::after {
  content: '‚Üë';
  opacity: 1;
  color: #667eea;
}

table th.sorted-desc::after {
  content: '‚Üì';
  opacity: 1;
  color: #667eea;
}

table tbody tr:hover {
  background: #f8f9fa;
}

.btn-edit {
  background: #f39c12;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  margin-right: 5px;
}

.btn-edit:hover {
  background: #e67e22;
}

.btn-delete {
  background: #e74c3c;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.btn-delete:hover {
  background: #c0392b;
}

/* DASHBOARD */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.dashboard-card {
  background: #fff;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  text-align: center;
  border-left: 4px solid #667eea;
}

.dashboard-card h3 {
  color: #666;
  font-size: 14px;
  margin-bottom: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.dashboard-card p {
  font-size: 28px;
  font-weight: 700;
  color: #764ba2;
}

.dashboard-card small {
  display: block;
  margin-top: 8px;
  font-size: 12px;
  color: #999;
}

/* ALERTAS E NOTIFICA√á√ïES */
.alert {
  padding: 12px 16px;
  border-radius: 6px;
  margin-bottom: 15px;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.alert-info {
  background: #d1ecf1;
  color: #0c5460;
  border-left: 4px solid #17a2b8;
}

.alert-warning {
  background: #fff3cd;
  color: #856404;
  border-left: 4px solid #ffc107;
}

.alert-success {
  background: #d4edda;
  color: #155724;
  border-left: 4px solid #28a745;
}

/* FILTROS */
.filter-section {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  border: 1px solid #e0e0e0;
}

.filter-section h3 {
  color: #667eea;
  margin-bottom: 15px;
  font-size: 18px;
}

.filter-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 15px;
}

.filter-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

/* STATUS BADGES */
.status-pago {
  background: #28a745;
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

.status-aberto {
  background: #f39c12;
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

.status-atrasado {
  background: #e74c3c;
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

/* GR√ÅFICO */
.chart-container {
  position: relative;
  height: 300px;
  margin-top: 20px;
}

/* RESPONSIVIDADE */
@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    text-align: center;
  }
  
  .user-info {
    text-align: center;
    margin-top: 15px;
  }
  
  .filter-grid, .form-grid {
    grid-template-columns: 1fr;
  }
  
  .summary-grid {
    grid-template-columns: 1fr;
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .action-buttons button {
    width: 100%;
  }
}

/* LOADING */
.loading {
  display: none;
  text-align: center;
  padding: 20px;
  color: #667eea;
}

.loading.show {
  display: block;
}

/* SINCRONIZA√á√ÉO */
.sync-status {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #fff;
  padding: 15px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 9999;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s;
}

.sync-status.show {
  opacity: 1;
  transform: translateY(0);
}

.sync-status.success {
  border-left: 4px solid #28a745;
}

.sync-status.error {
  border-left: 4px solid #e74c3c;
}

.sync-status.syncing {
  border-left: 4px solid #667eea;
}

.spinner {
  width: 20px;
  height: 20px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.btn-sync {
  background: #667eea;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-sync:hover {
  background: #5568d3;
}

.btn-load {
  background: #28a745;
  color: #fff;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-load:hover {
  background: #218838;
}
/* ==================== MODO ESCURO ==================== */
body.dark-mode {
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
}

body.dark-mode .main-container {
  background: #0f3460;
}

body.dark-mode .login-container,
body.dark-mode .main-card,
body.dark-mode .module-content,
body.dark-mode .form-card,
body.dark-mode .dashboard-card,
body.dark-mode table {
  background: #1a1a2e;
  color: #e0e0e0;
}

body.dark-mode .main-card h3,
body.dark-mode .form-card h3,
body.dark-mode .dashboard-card h3,
body.dark-mode label,
body.dark-mode .summary-section h3,
body.dark-mode .filter-section h3 {
  color: #e0e0e0;
}

body.dark-mode .main-card p {
  color: #b0b0b0;
}

body.dark-mode input,
body.dark-mode select,
body.dark-mode textarea {
  background: #0f3460;
  color: #e0e0e0;
  border-color: #533483;
}

body.dark-mode input:focus,
body.dark-mode select:focus,
body.dark-mode textarea:focus {
  border-color: #667eea;
}

body.dark-mode table th {
  background: #16213e;
  color: #e0e0e0;
}

body.dark-mode table th:hover {
  background: #1f2d4d;
}

body.dark-mode table tbody tr:hover {
  background: #16213e;
}

body.dark-mode .filter-section {
  background: #1a1a2e;
  border-color: #533483;
}

body.dark-mode .form-card.editing {
  background: #1f2d4d;
  border-color: #667eea;
}

body.dark-mode .sync-status {
  background: #1a1a2e;
  color: #e0e0e0;
}

body.dark-mode .config-section {
  background: #2c2c1e;
  border-color: #ffc107;
}

body.dark-mode .config-section h3 {
  color: #ffc107;
}

body.dark-mode .alert-info {
  background: #1c3a47;
  color: #8dd4f0;
  border-left-color: #17a2b8;
}

body.dark-mode .alert-warning {
  background: #3d3420;
  color: #f0d48d;
  border-left-color: #ffc107;
}

body.dark-mode .alert-success {
  background: #1e3d2c;
  color: #8df0b0;
  border-left-color: #28a745;
}

/* Bot√£o de altern√¢ncia de tema */
.theme-toggle {
  position: fixed;
  bottom: 80px;
  right: 20px;
  background: #667eea;
  color: white;
  border: none;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 24px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  z-index: 9998;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.theme-toggle:hover {
  transform: scale(1.1);
  background: #5568d3;
}

body.dark-mode .theme-toggle {
  background: #ffc107;
  color: #1a1a2e;
}

body.dark-mode .theme-toggle:hover {
  background: #e0a800;
}

/* Cards adicionais do Dashboard */
.dashboard-card.receita-recebida {
  border-left-color: #28a745;
}

.dashboard-card.receita-receber {
  border-left-color: #20c997;
}

.dashboard-card.despesa-paga {
  border-left-color: #e74c3c;
}

.dashboard-card.despesa-pagar {
  border-left-color: #f39c12;
}

.dashboard-card.saldo-liquido {
  border-left-color: #667eea;
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
}

body.dark-mode .dashboard-card.saldo-liquido {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
}

/* ==================== NOVOS M√ìDULOS ==================== */

/* Compara√ß√£o de Per√≠odos */
.comparison-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.comparison-card {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  border-left: 4px solid #667eea;
}

.comparison-card h4 {
  color: #667eea;
  margin-bottom: 15px;
  font-size: 16px;
}

.comparison-values {
  display: flex;
  justify-content: space-between;
  margin: 10px 0;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 4px;
}

.comparison-positive {
  color: #28a745;
  font-weight: 700;
}

.comparison-negative {
  color: #e74c3c;
  font-weight: 700;
}

body.dark-mode .comparison-card {
  background: #1a1a2e;
}

body.dark-mode .comparison-values {
  background: #0f3460;
}

/* Gest√£o de Categorias */
.category-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 6px;
  margin-bottom: 10px;
  border-left: 4px solid #667eea;
}

.category-item .category-name {
  font-weight: 600;
  font-size: 14px;
}

.category-actions {
  display: flex;
  gap: 5px;
}

body.dark-mode .category-item {
  background: #0f3460;
}

/* Metas Financeiras */
.goal-card {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  border-left: 4px solid #667eea;
}

.goal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.goal-title {
  font-size: 18px;
  font-weight: 700;
  color: #333;
}

.goal-status {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.goal-status.active {
  background: #28a745;
  color: white;
}

.goal-status.completed {
  background: #667eea;
  color: white;
}

.goal-progress-bar {
  width: 100%;
  height: 30px;
  background: #e9ecef;
  border-radius: 15px;
  overflow: hidden;
  margin: 15px 0;
  position: relative;
}

.goal-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  transition: width 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 12px;
}

.goal-info {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  color: #666;
}

body.dark-mode .goal-card {
  background: #1a1a2e;
}

body.dark-mode .goal-title {
  color: #e0e0e0;
}

body.dark-mode .goal-progress-bar {
  background: #0f3460;
}

body.dark-mode .goal-info {
  color: #b0b0b0;
}

/* Or√ßamento por Categoria */
.budget-card {
  background: #fff;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.budget-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.budget-category {
  font-weight: 700;
  font-size: 16px;
  color: #333;
}

.budget-status {
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 4px;
  font-weight: 600;
}

.budget-status.ok {
  background: #d4edda;
  color: #155724;
}

.budget-status.warning {
  background: #fff3cd;
  color: #856404;
}

.budget-status.danger {
  background: #f8d7da;
  color: #721c24;
}

.budget-bar {
  width: 100%;
  height: 20px;
  background: #e9ecef;
  border-radius: 10px;
  overflow: hidden;
  margin: 10px 0;
}

.budget-fill {
  height: 100%;
  transition: width 0.3s;
}

.budget-fill.ok {
  background: #28a745;
}

.budget-fill.warning {
  background: #ffc107;
}

.budget-fill.danger {
  background: #e74c3c;
}

.budget-values {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  color: #666;
}

body.dark-mode .budget-card {
  background: #1a1a2e;
}

body.dark-mode .budget-category {
  color: #e0e0e0;
}

body.dark-mode .budget-bar {
  background: #0f3460;
}

body.dark-mode .budget-values {
  color: #b0b0b0;
}

/* Badge de notifica√ß√£o */
.notification-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  background: #e74c3c;
  color: white;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 700;
}

/* ==================== PROJE√á√ÉO DE ATIVOS ==================== */
.projection-controls {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  border: 2px solid #667eea;
}

.projection-selector {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
  margin-bottom: 15px;
}

.projection-btn {
  padding: 12px;
  background: #fff;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
}

.projection-btn:hover {
  border-color: #667eea;
  background: #f0f4ff;
}

.projection-btn.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-color: #667eea;
}

.projection-results {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.projection-card {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  border-left: 4px solid #667eea;
}

.projection-card h4 {
  color: #667eea;
  margin-bottom: 15px;
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.projection-card .current-value {
  font-size: 14px;
  color: #666;
  margin-bottom: 10px;
}

.projection-card .projected-value {
  font-size: 28px;
  font-weight: 700;
  color: #28a745;
  margin: 10px 0;
}

.projection-card .gain {
  font-size: 14px;
  color: #28a745;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 5px;
}

.projection-card .details {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #e0e0e0;
  font-size: 13px;
  color: #666;
}

.projection-card .details div {
  margin: 5px 0;
  display: flex;
  justify-content: space-between;
}

.projection-summary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 30px;
  border-radius: 12px;
  margin-top: 30px;
  text-align: center;
}

.projection-summary h3 {
  font-size: 20px;
  margin-bottom: 20px;
}

.projection-summary .total-projected {
  font-size: 48px;
  font-weight: 700;
  margin: 20px 0;
}

.projection-summary .total-gain {
  font-size: 24px;
  opacity: 0.9;
}

body.dark-mode .projection-card {
  background: #1a1a2e;
}

body.dark-mode .projection-card h4 {
  color: #667eea;
}

body.dark-mode .projection-card .current-value,
body.dark-mode .projection-card .details {
  color: #b0b0b0;
}

body.dark-mode .projection-controls {
  background: #1a1a2e;
  border-color: #667eea;
}

body.dark-mode .projection-btn {
  background: #0f3460;
  color: #e0e0e0;
  border-color: #533483;
}

body.dark-mode .projection-btn:hover {
  background: #1f2d4d;
}

.projection-chart {
  margin-top: 30px;
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

body.dark-mode .projection-chart {
  background: #1a1a2e;
}

/* Toggle de visualiza√ß√£o de per√≠odo */
.period-toggle {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border: 2px solid #667eea;
}

.period-toggle-buttons {
  display: flex;
  gap: 10px;
}

.period-toggle-btn {
  padding: 10px 20px;
  background: #fff;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  font-size: 14px;
}

.period-toggle-btn:hover {
  border-color: #667eea;
  background: #f0f4ff;
}

.period-toggle-btn.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-color: #667eea;
}

.period-info {
  font-size: 14px;
  color: #666;
  font-weight: 600;
}

body.dark-mode .period-toggle {
  background: #1a1a2e;
  border-color: #667eea;
}

body.dark-mode .period-toggle-btn {
  background: #0f3460;
  color: #e0e0e0;
  border-color: #533483;
}

body.dark-mode .period-toggle-btn:hover {
  background: #1f2d4d;
}

body.dark-mode .period-info {
  color: #b0b0b0;
}
</style>
</head>

<body>

<!-- TELA DE LOGIN -->
<div class="login-container" id="loginScreen">
  <h2>üí∞ Sistema Financeiro</h2>
  
  <form onsubmit="fazerLogin(event)">
    <div class="form-group">
      <label for="loginNome">Nome Completo <span style="color: red;">*</span></label>
      <input type="text" id="loginNome" required>
    </div>
    
    <div class="form-group">
      <label for="loginEmail">E-mail (opcional)</label>
      <input type="email" id="loginEmail" placeholder="seu@email.com">
    </div>
    
    <button type="submit" class="btn-entrar">Entrar no Sistema</button>
  </form>
</div>

<!-- TELA PRINCIPAL -->
<div class="main-container" id="mainScreen">
  <div class="header">
  <div class="header-content">
    <div>
      <h1>üí∞ Sistema Financeiro Pessoal</h1>
      <a href="#" id="sheetLink" target="_blank" style="color: white; font-size: 12px; opacity: 0.8; text-decoration: none; display: none;">
        üìä Abrir Planilha no Google Sheets
      </a>
    </div>
    <div class="user-info">
      <div class="user-name" id="userName"></div>
      <button class="btn-sair" onclick="fazerLogout()">Sair</button>
    </div>
  </div>
</div>

  <div class="cards-container">
    <div class="main-card" onclick="openModule('financeiro')">
      <div class="icon">üí∏</div>
      <h3>Financeiro</h3>
      <p>Controle suas receitas e despesas</p>
    </div>
    
    <div class="main-card" onclick="openModule('investimento')">
      <div class="icon">üìà</div>
      <h3>Investimentos</h3>
      <p>Gerencie sua carteira</p>
    </div>
    
    <div class="main-card" onclick="openModule('consignacao')">
      <div class="icon">ü§ù</div>
      <h3>Consigna√ß√£o</h3>
      <p>Controle de empr√©stimos</p>
    </div>
    
    <div class="main-card" onclick="openModule('anotacoes')">
      <div class="icon">üìù</div>
      <h3>Anota√ß√µes</h3>
      <p>Lembretes e observa√ß√µes</p>
    </div>
    
    <div class="main-card" onclick="openModule('vendas')">
      <div class="icon">üõçÔ∏è</div>
      <h3>Vendas</h3>
      <p>Gest√£o de produtos e servi√ßos</p>
    </div>
    
    <div class="main-card" onclick="openModule('dashboard')">
      <div class="icon">üìä</div>
      <h3>Dashboard</h3>
      <p>Vis√£o geral financeira</p>
    </div>
    
    <div class="main-card" onclick="openModule('configuracao')">
      <div class="icon">‚öôÔ∏è</div>
      <h3>Configura√ß√µes</h3>
      <p>Configurar sincroniza√ß√£o</p>
    </div>
    <!-- NOVOS CARDS -->
<div class="main-card" onclick="openModule('comparacao')">
  <div class="icon">üìä</div>
  <h3>Compara√ß√£o de Per√≠odos</h3>
  <p>Compare receitas e despesas</p>
</div>

<div class="main-card" onclick="openModule('categorias')">
  <div class="icon">üè∑Ô∏è</div>
  <h3>Gerenciar Categorias</h3>
  <p>Crie suas pr√≥prias categorias</p>
</div>

<div class="main-card" onclick="openModule('metas')">
  <div class="icon">üéØ</div>
  <h3>Metas Financeiras</h3>
  <p>Defina e acompanhe metas</p>
</div>

<div class="main-card" onclick="openModule('orcamento')">
  <div class="icon">üí∞</div>
  <h3>Or√ßamento por Categoria</h3>
  <p>Controle seus limites de gastos</p>
</div>
<!-- ADICIONE ESTE CARD AP√ìS O CARD DE OR√áAMENTO -->
<div class="main-card" onclick="openModule('projecao')">
  <div class="icon">üìä</div>
  <h3>Proje√ß√£o de Ativos</h3>
  <p>Simule o crescimento dos seus investimentos</p>
</div>
  <!-- CARD DE FECHAMENTO MENSAL -->
    <div class="main-card" onclick="openModule('fechamento')">
      <div class="icon">üìÖ</div>
      <h3>Fechamento Mensal</h3>
      <p>Visualize e feche seus meses</p>
    </div>
  </div>
</div>

<!-- M√ìDULO CONFIGURA√á√ÉO -->
<div class="module-container" id="moduleConfiguracao">
  <div class="module-content">
    <div class="module-header">
      <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
      <button class="btn-close" onclick="closeModule('configuracao')">&times;</button>
    </div>
    <div class="module-body">
      
      <div class="config-section">
  <h3>üîó URL do Google Apps Script</h3>
  <p style="margin-bottom: 10px;">Cole aqui a URL do seu Google Apps Script para habilitar a sincroniza√ß√£o com o Google Sheets.</p>
  <input type="text" id="sheetsUrlInput" placeholder="https://script.google.com/macros/s/SEU_ID/exec">
  
  <p style="margin: 15px 0 10px 0; font-weight: 600;">Link da Planilha do Google Sheets:</p>
  <input type="text" id="spreadsheetUrlInput" placeholder="https://docs.google.com/spreadsheets/d/SEU_ID_DA_PLANILHA/edit">
  
  <button class="btn-primary" onclick="salvarSheetsUrl()">Salvar Configura√ß√µes</button>
  <small>
    <strong>Status atual:</strong> <span id="urlStatus">N√£o configurado</span>
  </small>
</div>
      
      <div class="alert alert-info">
        <span>‚ÑπÔ∏è</span>
        <div>
          <strong>Como configurar:</strong>
          <ol style="margin: 8px 0 0 20px; line-height: 1.6;">
            <li>Abra o Google Sheets e crie uma nova planilha</li>
            <li>V√° em <strong>Extens√µes > Apps Script</strong></li>
            <li>Cole o c√≥digo fornecido no arquivo "codigo-google-apps-script.js"</li>
            <li>Clique em <strong>Implantar > Nova implanta√ß√£o</strong></li>
            <li>Selecione tipo: <strong>Aplicativo da Web</strong></li>
            <li>Configurar: <strong>Quem tem acesso: Qualquer pessoa</strong></li>
            <li>Copie a URL gerada e cole acima</li>
          </ol>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- M√ìDULO FINANCEIRO -->
<div class="module-container" id="moduleFinanceiro">
  <div class="module-content">
    <div class="module-header">
      <h2>üí∞ Movimenta√ß√µes Financeiras</h2>
      <button class="btn-close" onclick="closeModule('financeiro')">&times;</button>
    </div>
    <div class="module-body">
      <!-- TOGGLE DE PER√çODO -->
<div class="period-toggle">
  <div class="period-info">
    üìÖ Visualiza√ß√£o: <span id="currentPeriodDisplay">M√™s Atual</span>
  </div>
  <div class="period-toggle-buttons">
    <button class="period-toggle-btn active" onclick="setPeriodView('current')">
      üìä M√™s Atual
    </button>
    <button class="period-toggle-btn" onclick="setPeriodView('all')">
      üìÖ Todos os Meses
    </button>
  </div>
</div>
      
      <!-- RESUMO POR CATEGORIA -->
      <div class="summary-section">
        <h3>Resumo por Categoria (Com Recorr√™ncias Calculadas)</h3>
        <div class="summary-grid" id="financeiroCategorySummary"></div>
      </div>
      
      <!-- FORMUL√ÅRIO -->
      <div class="form-card" id="formFinanceiro">
        <h3 id="finFormTitle">Nova Transa√ß√£o</h3>
        <input type="hidden" id="f_id">
        
        <div class="form-grid">
          <div class="form-group-inline">
            <label for="f_data">Data e Hora *</label>
            <input type="datetime-local" id="f_data" required>
          </div>
          
          <div class="form-group-inline">
            <label for="f_tipo">Tipo *</label>
            <select id="f_tipo" required>
              <option value="Recebido">Receita (Recebido)</option>
              <option value="Pago">Despesa (Pago)</option>
              <option value="Pagar">Despesa (A Pagar)</option>
              <option value="A Receber">Receita (A Receber)</option>
            </select>
          </div>
          
          <div class="form-group-inline">
            <label for="f_valor">Valor (R$) *</label>
            <input type="text" id="f_valor" placeholder="0,00" required>
          </div>
          
          <div class="form-group-inline">
            <label for="f_desc">Descri√ß√£o *</label>
            <input type="text" id="f_desc" placeholder="Descri√ß√£o da transa√ß√£o" required>
          </div>
          
          <div class="form-group-inline">
            <label for="f_cat">Categoria</label>
            <select id="f_cat">
              <option>Sal√°rio</option>
              <option>Alimenta√ß√£o</option>
              <option>Transporte</option>
              <option>Moradia</option>
              <option>Sa√∫de</option>
              <option>Educa√ß√£o</option>
              <option>Lazer</option>
              <option>Investimentos</option>
              <option>Outros</option>
            </select>
          </div>
          
          <div class="form-group-inline">
            <label for="f_rec">Recorr√™ncia</label>
            <select id="f_rec">
              <option>N√£o</option>
              <option>Di√°rio</option>
              <option>Mensal</option>
              <option>Bimestral</option>
              <option>Trimestral</option>
              <option>Semestral</option>
              <option>Anual</option>
            </select>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn-primary" id="btnSaveFin" onclick="saveFinanceiro()">Adicionar Transa√ß√£o</button>
          <button class="btn-secondary" id="btnCancelFin" onclick="resetFinForm()" style="display:none">Cancelar</button>
          <button class="btn-sync" onclick="syncToSheets('financeiro')">
            <span>üîÑ</span>
            <span>Enviar para Sheets</span>
          </button>
          <button class="btn-load" onclick="loadFromSheets('financeiro')">
            <span>üì•</span>
            <span>Carregar do Sheets</span>
          </button>
          <button class="btn-export" onclick="exportToCSV('financeiro')">Exportar CSV</button>
        </div>
      </div>
      
     <!-- FILTROS MELHORADOS -->
<div class="filter-section">
  <h3>üîç Filtros Avan√ßados</h3>
  <!-- ALERTA DE FILTRO ATIVO -->
  
  <!-- FILTROS R√ÅPIDOS -->
  <div style="margin-bottom: 15px;">
    <label style="font-weight: 600; color: #333; margin-bottom: 8px; display: block;">Filtros R√°pidos:</label>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <button class="btn-primary" onclick="filtrarHoje('financeiro')" style="padding: 8px 16px;">üìÖ Hoje</button>
      <button class="btn-primary" onclick="filtrarSemana('financeiro')" style="padding: 8px 16px;">üìÜ Esta Semana</button>
      <button class="btn-primary" onclick="filtrarMes('financeiro')" style="padding: 8px 16px;">üìä Este M√™s</button>
      <button class="btn-secondary" onclick="mostrarTodos('financeiro')" style="padding: 8px 16px;">üëÅÔ∏è Mostrar Todos</button>
    </div>
  </div>
  
  <!-- BUSCA POR TEXTO -->
  <div style="margin-bottom: 15px;">
    <label style="font-weight: 600; color: #333; margin-bottom: 8px; display: block;">üîç Buscar:</label>
    <input type="text" id="searchFinanceiro" placeholder="Digite para buscar (descri√ß√£o, categoria, valor...)" 
           style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 6px;" 
           oninput="buscarFinanceiro()">
  </div>
  
  <!-- FILTROS PERSONALIZADOS -->
  <div class="filter-grid">
    <div class="form-group-inline">
      <label for="filterFinDataInicio">Data In√≠cio</label>
      <input type="date" id="filterFinDataInicio">
    </div>
    <div class="form-group-inline">
      <label for="filterFinDataFim">Data Fim</label>
      <input type="date" id="filterFinDataFim">
    </div>
    <div class="form-group-inline">
      <label for="filterFinTipo">Tipo</label>
      <select id="filterFinTipo">
        <option value="">Todos</option>
        <option value="Recebido">Recebido</option>
        <option value="Pago">Pago</option>
        <option value="Pagar">A Pagar</option>
        <option value="A Receber">A Receber</option>
      </select>
    </div>
    <div class="form-group-inline">
      <label for="filterFinCategoria">Categoria</label>
      <select id="filterFinCategoria">
        <option value="">Todas</option>
        <option value="Sal√°rio">Sal√°rio</option>
        <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
        <option value="Transporte">Transporte</option>
        <option value="Moradia">Moradia</option>
        <option value="Sa√∫de">Sa√∫de</option>
        <option value="Educa√ß√£o">Educa√ß√£o</option>
        <option value="Lazer">Lazer</option>
        <option value="Investimentos">Investimentos</option>
        <option value="Outros">Outros</option>
      </select>
    </div>
  </div>
  <div class="filter-actions">
    <button class="btn-primary" onclick="applyFinanceiroFilters()">Aplicar Filtros</button>
    <button class="btn-secondary" onclick="clearFinanceiroFilters()">Limpar Tudo</button>
  </div>
</div>
      <!-- TABELA -->
      <div class="data-table">
        <h3>Hist√≥rico de Transa√ß√µes</h3>
        <table id="financeiroTable">
          <thead>
            <tr>
              <th class="sortable" onclick="sortTable('financeiroTable', 0)">Data</th>
              <th class="sortable" onclick="sortTable('financeiroTable', 1)">Tipo</th>
              <th class="sortable" onclick="sortTable('financeiroTable', 2)">Descri√ß√£o</th>
              <th class="sortable" onclick="sortTable('financeiroTable', 3)">Categoria</th>
              <th class="sortable" onclick="sortTable('financeiroTable', 4)">Valor</th>
              <th>Recorr√™ncia</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- M√ìDULO INVESTIMENTOS -->
<div class="module-container" id="moduleInvestimento">
  <div class="module-content">
    <div class="module-header">
      <h2>üìà Carteira de Investimentos</h2>
      <button class="btn-close" onclick="closeModule('investimento')">&times;</button>
    </div>
    <div class="module-body">
      
      <div class="summary-section">
        <h3>Resumo por Modalidade (Com Recorr√™ncias Calculadas)</h3>
        <div class="summary-grid" id="investimentoModalitySummary"></div>
      </div>
      
      <div class="form-card" id="formInvest">
        <h3 id="invFormTitle">Novo Investimento</h3>
        <input type="hidden" id="i_id">
        
<!-- FILTROS INVESTIMENTOS -->
<div class="filter-section">
  <h3>üîç Filtros e Busca</h3>
  
  <!-- BUSCA -->
  <div style="margin-bottom: 15px;">
    <label style="font-weight: 600; color: #333; margin-bottom: 8px; display: block;">üîç Buscar:</label>
    <input type="text" id="searchInvestimentos" placeholder="Digite para buscar (ativo, modalidade...)" 
           style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 6px;" 
           oninput="buscarInvestimentos()">
  </div>
  
  <!-- FILTROS -->
  <div class="filter-grid">
    <div class="form-group-inline">
      <label for="filterInvModalidade">Modalidade</label>
      <select id="filterInvModalidade" onchange="filtrarInvestimentos()">
        <option value="">Todas</option>
        <option value="A√ß√µes">A√ß√µes</option>
        <option value="FIIs">FIIs</option>
        <option value="Renda Fixa">Renda Fixa</option>
        <option value="CDB">CDB</option>
        <option value="Tesouro Direto">Tesouro Direto</option>
        <option value="Criptomoedas">Criptomoedas</option>
        <option value="Fundos">Fundos</option>
        <option value="Outros">Outros</option>
      </select>
    </div>
  </div>
  
  <button class="btn-secondary" onclick="limparFiltrosInvestimentos()" style="margin-top: 10px;">Limpar Filtros</button>
</div>
        
        <div class="form-grid">
          <div class="form-group-inline">
            <label for="i_ativo">Ativo/C√≥digo *</label>
            <input type="text" id="i_ativo" placeholder="Ex: PETR4, HGLG11" required>
          </div>
          
          <div class="form-group-inline">
            <label for="i_mod">Modalidade *</label>
            <select id="i_mod" required>
              <option>A√ß√µes</option>
              <option>FIIs</option>
              <option>Renda Fixa</option>
              <option>CDB</option>
              <option>Tesouro Direto</option>
              <option>Criptomoedas</option>
              <option>Fundos</option>
              <option>Outros</option>
            </select>
          </div>
          
          <div class="form-group-inline">
            <label for="i_data">Data da Compra</label>
            <input type="date" id="i_data">
          </div>
          
          <div class="form-group-inline">
            <label for="i_valor">Valor Investido (R$) *</label>
            <input type="text" id="i_valor" placeholder="0,00" required>
          </div>
          
          <div class="form-group-inline">
            <label for="i_qtd">Quantidade</label>
            <input type="number" id="i_qtd" step="0.01" placeholder="0">
          </div>
          
          <div class="form-group-inline">
            <label for="i_prov">Provento (R$)</label>
            <input type="text" id="i_prov" placeholder="0,00">
          </div>
          
          <div class="form-group-inline">
            <label for="i_rec">Recorr√™ncia de Proventos</label>
            <select id="i_rec">
              <option>N√£o</option>
              <option>Di√°rio</option>
              <option>Mensal</option>
              <option>Bimestral</option>
              <option>Trimestral</option>
              <option>Semestral</option>
              <option>Anual</option>
            </select>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn-primary" id="btnSaveInv" onclick="saveInvestimento()">Adicionar Investimento</button>
          <button class="btn-secondary" id="btnCancelInv" onclick="resetInvForm()" style="display:none">Cancelar</button>
          <button class="btn-sync" onclick="syncToSheets('investimentos')">
            <span>üîÑ</span>
            <span>Enviar para Sheets</span>
          </button>
          <button class="btn-load" onclick="loadFromSheets('investimentos')">
            <span>üì•</span>
            <span>Carregar do Sheets</span>
          </button>
          <button class="btn-export" onclick="exportToCSV('investimento')">Exportar CSV</button>
        </div>
      </div>
      
      <div class="data-table">
        <h3>Meus Investimentos</h3>
        <table id="investTable">
          <thead>
            <tr>
              <th class="sortable" onclick="sortTable('investTable', 0)">Ativo</th>
              <th class="sortable" onclick="sortTable('investTable', 1)">Modalidade</th>
              <th class="sortable" onclick="sortTable('investTable', 2)">Valor Investido</th>
              <th class="sortable" onclick="sortTable('investTable', 3)">Quantidade</th>
              <th class="sortable" onclick="sortTable('investTable', 4)">Provento</th>
              <th>Recorr√™ncia</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="module-container" id="moduleConsignacao">
  <div class="module-content">
    <div class="module-header">
      <h2>ü§ù Controle de Empr√©stimos e Consigna√ß√£o</h2>
      <button class="btn-close" onclick="closeModule('consignacao')">&times;</button>
    </div>
    <div class="module-body">
      
      <div class="summary-section">
        <h3>Resumo de Empr√©stimos</h3>
        <div class="summary-grid">
          <div class="summary-card highlight">
            <h4>Total Emprestado</h4>
            <p id="totalEmprestado">R$ 0,00</p>
          </div>
          <div class="summary-card">
            <h4>Total Recebido</h4>
            <p id="totalRecebido">R$ 0,00</p>
          </div>
          <div class="summary-card warning">
            <h4>Em Aberto</h4>
            <p id="totalAberto">R$ 0,00</p>
          </div>
          <div class="summary-card danger">
            <h4>Atrasados</h4>
            <p id="totalAtrasado">0</p>
          </div>
        </div>
      </div>
      
      <div class="alert alert-warning">
        <span>‚ö†Ô∏è</span>
        <span>Juros m√°ximo permitido por lei: 100% ao m√™s. O sistema validar√° automaticamente.</span>
      </div>
      
      <div class="form-card" id="formConsignacao">
        <h3 id="consigFormTitle">Novo Empr√©stimo</h3>
        <input type="hidden" id="c_id">
        
        <!-- FILTROS CONSIGNA√á√ÉO -->
<div class="filter-section">
  <h3>üîç Filtros e Busca</h3>
  
  <!-- BUSCA -->
  <div style="margin-bottom: 15px;">
    <label style="font-weight: 600; color: #333; margin-bottom: 8px; display: block;">üîç Buscar:</label>
    <input type="text" id="searchConsignacao" placeholder="Digite para buscar (nome, contato...)" 
           style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 6px;" 
           oninput="buscarConsignacao()">
  </div>
  
  <!-- FILTROS -->
  <div class="filter-grid">
    <div class="form-group-inline">
      <label for="filterConsStatus">Status</label>
      <select id="filterConsStatus" onchange="filtrarConsignacao()">
        <option value="">Todos</option>
        <option value="pago">Pago</option>
        <option value="aberto">Em Aberto</option>
        <option value="atrasado">Atrasado</option>
      </select>
    </div>
    <div class="form-group-inline">
      <label for="filterConsDataInicio">Vencimento de:</label>
      <input type="date" id="filterConsDataInicio">
    </div>
    <div class="form-group-inline">
      <label for="filterConsDataFim">Vencimento at√©:</label>
      <input type="date" id="filterConsDataFim">
    </div>
  </div>
  
  <div style="margin-top: 10px; display: flex; gap: 10px;">
    <button class="btn-primary" onclick="filtrarConsignacao()">Aplicar Filtros</button>
    <button class="btn-secondary" onclick="limparFiltrosConsignacao()">Limpar</button>
  </div>
</div>
        
        <div class="form-grid">
          <div class="form-group-inline">
            <label for="c_nome">Nome do Tomador *</label>
            <input type="text" id="c_nome" placeholder="Nome completo" required>
          </div>
          
          <div class="form-group-inline">
            <label for="c_valor">Valor (R$) *</label>
            <input type="text" id="c_valor" placeholder="0,00" required>
          </div>
          
          <div class="form-group-inline">
            <label for="c_juros">Juros Mensal (%) *</label>
            <input type="number" id="c_juros" placeholder="0.00" step="0.01" max="5" required>
            <small style="color: #666; font-size: 11px;">M√°x: 5%</small>
          </div>
          
          <div class="form-group-inline">
            <label for="c_parcelas">N√∫mero de Parcelas *</label>
            <input type="number" id="c_parcelas" placeholder="1" min="1" required>
          </div>
          
          <div class="form-group-inline">
            <label for="c_vencimento">Data de Vencimento *</label>
            <input type="date" id="c_vencimento" required>
          </div>
          
          <div class="form-group-inline">
            <label for="c_contato">Contato (opcional)</label>
            <input type="text" id="c_contato" placeholder="Telefone ou email">
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn-primary" id="btnSaveCons" onclick="saveConsignacao()">Adicionar Empr√©stimo</button>
          <button class="btn-secondary" id="btnCancelCons" onclick="resetConsForm()" style="display:none">Cancelar</button>
          <button class="btn-sync" onclick="syncToSheets('consignacoes')">
            <span>üîÑ</span>
            <span>Enviar para Sheets</span>
          </button>
          <button class="btn-load" onclick="loadFromSheets('consignacoes')">
            <span>üì•</span>
            <span>Carregar do Sheets</span>
          </button>
          <button class="btn-export" onclick="exportConsignacaoCSV()">Exportar CSV</button>
          <button class="btn-export" onclick="exportConsignacaoPDF()">Exportar PDF</button>
        </div>
      </div>
      
      <div class="data-table">
        <h3>Empr√©stimos Cadastrados</h3>
        <table id="consignacaoTable">
          <thead>
            <tr>
              <th class="sortable" onclick="sortTable('consignacaoTable', 0)">Nome</th>
              <th class="sortable" onclick="sortTable('consignacaoTable', 1)">Valor Inicial</th>
              <th class="sortable" onclick="sortTable('consignacaoTable', 2)">Juros</th>
              <th class="sortable" onclick="sortTable('consignacaoTable', 3)">Total com Juros</th>
              <th class="sortable" onclick="sortTable('consignacaoTable', 4)">Pago</th>
              <th class="sortable" onclick="sortTable('consignacaoTable', 5)">Vencimento</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div class="data-table">
        <h3>An√°lise Visual</h3>
        <div class="chart-container">
          <canvas id="consignacaoChart"></canvas>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- M√ìDULO ANOTA√á√ïES -->
<div class="module-container" id="moduleAnotacoes">
  <div class="module-content">
    <div class="module-header">
      <h2>üìù Minhas Anota√ß√µes</h2>
      <button class="btn-close" onclick="closeModule('anotacoes')">&times;</button>
    </div>
    <div class="module-body">
      
      <div class="summary-section">
        <h3>Resumo por Prioridade</h3>
        <div class="summary-grid" id="anotacoesPrioritySummary"></div>
      </div>
      
      <div class="form-card" id="formAnot">
        <h3 id="anotFormTitle">Nova Anota√ß√£o</h3>
        <input type="hidden" id="a_id">
        
        <!-- FILTROS ANOTA√á√ïES -->
<div class="filter-section">
  <h3>üîç Filtros e Busca</h3>
  
  <!-- BUSCA -->
  <div style="margin-bottom: 15px;">
    <label style="font-weight: 600; color: #333; margin-bottom: 8px; display: block;">üîç Buscar:</label>
    <input type="text" id="searchAnotacoes" placeholder="Digite para buscar (t√≠tulo, notas...)" 
           style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 6px;" 
           oninput="buscarAnotacoes()">
  </div>
  
  <!-- FILTROS -->
  <div class="filter-grid">
    <div class="form-group-inline">
      <label for="filterAnotPrioridade">Prioridade</label>
      <select id="filterAnotPrioridade" onchange="filtrarAnotacoes()">
        <option value="">Todas</option>
        <option value="Alta">Alta</option>
        <option value="M√©dia">M√©dia</option>
        <option value="Baixa">Baixa</option>
      </select>
    </div>
  </div>
  
  <button class="btn-secondary" onclick="limparFiltrosAnotacoes()" style="margin-top: 10px;">Limpar Filtros</button>
</div>
        
        <div class="form-grid">
          <div class="form-group-inline">
            <label for="a_titulo">T√≠tulo *</label>
            <input type="text" id="a_titulo" placeholder="T√≠tulo da anota√ß√£o" required>
          </div>
          
          <div class="form-group-inline">
            <label for="a_prioridade">Prioridade</label>
            <select id="a_prioridade">
              <option>Baixa</option>
              <option>M√©dia</option>
              <option>Alta</option>
            </select>
          </div>
        </div>
        
        <div class="form-group-inline">
          <label for="a_notas">Notas/Descri√ß√£o</label>
          <textarea id="a_notas" rows="4" placeholder="Escreva suas anota√ß√µes aqui..."></textarea>
        </div>
        
        <div class="action-buttons">
          <button class="btn-primary" id="btnSaveAnot" onclick="saveAnotacao()">Adicionar Anota√ß√£o</button>
          <button class="btn-secondary" id="btnCancelAnot" onclick="resetAnotForm()" style="display:none">Cancelar</button>
          <button class="btn-sync" onclick="syncToSheets('anotacoes')">
            <span>üîÑ</span>
            <span>Enviar para Sheets</span>
          </button>
          <button class="btn-load" onclick="loadFromSheets('anotacoes')">
            <span>üì•</span>
            <span>Carregar do Sheets</span>
          </button>
          <button class="btn-export" onclick="exportToCSV('anotacoes')">Exportar CSV</button>
        </div>
      </div>
      
      <div class="data-table">
        <h3>Todas as Anota√ß√µes</h3>
        <table id="anotacoesTable">
          <thead>
            <tr>
              <th class="sortable" onclick="sortTable('anotacoesTable', 0)">T√≠tulo</th>
              <th class="sortable" onclick="sortTable('anotacoesTable', 1)">Prioridade</th>
              <th class="sortable" onclick="sortTable('anotacoesTable', 2)">Notas</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- M√ìDULO VENDAS -->
<div class="module-container" id="moduleVendas">
  <div class="module-content">
    <div class="module-header">
      <h2>üõçÔ∏è Gest√£o de Vendas</h2>
      <button class="btn-close" onclick="closeModule('vendas')">&times;</button>
    </div>
    <div class="module-body">
      <div class="summary-section">
        <h3>Resumo de Vendas</h3>
        <div class="summary-grid">
          <div class="summary-card highlight">
            <h4>Total em Vendas</h4>
            <p id="totalVendasBruto">R$ 0,00</p>
          </div>
          <div class="summary-card">
            <h4>Lucro L√≠quido</h4>
            <p id="totalLucroVendas">R$ 0,00</p>
          </div>
        </div>
      </div>

      <div class="form-card" id="formVendas">
        <h3>Nova Venda</h3>
        <div class="form-grid">
          <div class="form-group-inline">
            <label for="v_cliente">Cliente *</label>
            <input type="text" id="v_cliente" placeholder="Nome do cliente" required>
          </div>
          <div class="form-group-inline">
            <label for="v_tipo">Tipo</label>
            <select id="v_tipo">
              <option>Produto</option>
              <option>Servi√ßo</option>
            </select>
          </div>
          <div class="form-group-inline">
            <label for="v_custo">Custo (R$)</label>
            <input type="text" id="v_custo" placeholder="0,00">
          </div>
          <div class="form-group-inline">
            <label for="v_valor">Valor Venda (R$) *</label>
            <input type="text" id="v_valor" placeholder="0,00" required>
          </div>
          <div class="form-group-inline">
            <label for="v_descricao">Descri√ß√£o</label>
            <input type="text" id="v_descricao" placeholder="Descri√ß√£o da venda">
          </div>
        </div>
        
        <!-- FILTROS VENDAS -->
<div class="filter-section">
  <h3>üîç Filtros e Busca</h3>
  
  <!-- BUSCA -->
  <div style="margin-bottom: 15px;">
    <label style="font-weight: 600; color: #333; margin-bottom: 8px; display: block;">üîç Buscar:</label>
    <input type="text" id="searchVendas" placeholder="Digite para buscar (cliente, descri√ß√£o...)" 
           style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 6px;" 
           oninput="buscarVendas()">
  </div>
  
  <!-- FILTROS -->
  <div class="filter-grid">
    <div class="form-group-inline">
      <label for="filterVendasTipo">Tipo</label>
      <select id="filterVendasTipo" onchange="filtrarVendas()">
        <option value="">Todos</option>
        <option value="Produto">Produto</option>
        <option value="Servi√ßo">Servi√ßo</option>
      </select>
    </div>
    <div class="form-group-inline">
      <label for="filterVendasDataInicio">Data In√≠cio</label>
      <input type="date" id="filterVendasDataInicio">
    </div>
    <div class="form-group-inline">
      <label for="filterVendasDataFim">Data Fim</label>
      <input type="date" id="filterVendasDataFim">
    </div>
  </div>
  
  <div style="margin-top: 10px; display: flex; gap: 10px;">
    <button class="btn-primary" onclick="filtrarVendas()">Aplicar Filtros</button>
    <button class="btn-secondary" onclick="limparFiltrosVendas()">Limpar</button>
  </div>
</div>
        <div class="action-buttons">
          <button class="btn-primary" onclick="saveVenda()">Registrar Venda</button>
          <button class="btn-sync" onclick="syncToSheets('vendas')">
            <span>üîÑ</span>
            <span>Enviar para Sheets</span>
          </button>
          <button class="btn-load" onclick="loadFromSheets('vendas')">
            <span>üì•</span>
            <span>Carregar do Sheets</span>
          </button>
          <button class="btn-export" onclick="exportToCSV('vendas')">Exportar CSV</button>
        </div>
      </div>

      <div class="data-table">
        <h3>Hist√≥rico de Vendas</h3>
        <table id="vendasTable">
          <thead>
            <tr>
              <th class="sortable" onclick="sortTable('vendasTable', 0)">Data</th>
              <th class="sortable" onclick="sortTable('vendasTable', 1)">Cliente</th>
              <th class="sortable" onclick="sortTable('vendasTable', 2)">Valor</th>
              <th class="sortable" onclick="sortTable('vendasTable', 3)">Lucro</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- M√ìDULO DASHBOARD -->
<div class="module-container" id="moduleDashboard">
  <div class="module-content">
    <div class="module-header">
      <h2>üìä Dashboard Financeiro</h2>
      <button class="btn-close" onclick="closeModule('dashboard')">&times;</button>
    </div>
   <div class="module-body">
  <!-- TOGGLE DE PER√çODO NO DASHBOARD -->
  <div class="period-toggle">
    <div class="period-info">
      üìÖ Visualiza√ß√£o: <span id="dashCurrentPeriodDisplay">Todos os Meses</span>
    </div>
    <div class="period-toggle-buttons">
      <button class="period-toggle-btn active" id="dashPeriodAll" onclick="setDashboardPeriod('all')">
        üìä Todos os Meses
      </button>
      <button class="period-toggle-btn" id="dashPeriodCurrent" onclick="setDashboardPeriod('current')">
        üìÖ M√™s Atual
      </button>
      <button class="period-toggle-btn" id="dashPeriodCustom" onclick="setDashboardPeriod('custom')">
        üîç M√™s Espec√≠fico
      </button>
    </div>
  </div>

  <!-- SELETOR DE M√äS ESPEC√çFICO (OCULTO POR PADR√ÉO) -->
  <div id="dashCustomMonthSelector" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #667eea;">
    <div class="form-grid">
      <div class="form-group-inline">
        <label for="dashCustomMonth">Selecione o M√™s:</label>
        <input type="month" id="dashCustomMonth" style="padding: 10px;">
      </div>
    </div>
    <button class="btn-primary" onclick="applyDashboardCustomMonth()" style="margin-top: 10px;">Aplicar</button>
  </div>
  
  <div class="alert alert-info">
    <span>‚ÑπÔ∏è</span>
    <span>Vis√£o consolidada de todas as suas finan√ßas, investimentos e empr√©stimos (com c√°lculo de recorr√™ncias)</span>
  </div>
  
  <div class="dashboard-grid">
    <!-- NOVOS CARDS DETALHADOS -->
    <div class="dashboard-card receita-recebida">
      <h3>üí∞ Receitas Recebidas</h3>
      <p id="dashReceitasRecebidas">R$ 0,00</p>
      <small>Valores j√° recebidos</small>
    </div>
    
    <div class="dashboard-card receita-receber">
      <h3>üì• Receitas a Receber</h3>
      <p id="dashReceitasAReceber">R$ 0,00</p>
      <small>Valores pendentes</small>
    </div>
    
    <div class="dashboard-card despesa-paga">
      <h3>üí∏ Despesas Pagas</h3>
      <p id="dashDespesasPagas">R$ 0,00</p>
      <small>Valores j√° pagos</small>
    </div>
    
    <div class="dashboard-card despesa-pagar">
      <h3>üì§ Despesas a Pagar</h3>
      <p id="dashDespesasAPagar">R$ 0,00</p>
      <small>Valores pendentes</small>
    </div>
    
    <div class="dashboard-card saldo-liquido">
      <h3>üíµ Saldo L√≠quido Real</h3>
      <p id="dashSaldoLiquido" style="font-size: 32px;">R$ 0,00</p>
      <small>Total Receitas - Total Despesas</small>
    </div>
    
    <!-- CARDS ORIGINAIS -->
    <div class="dashboard-card">
      <h3>Saldo Total</h3>
      <p id="dashSaldo">R$ 0,00</p>
      <small>Receitas - Despesas</small>
    </div>
    
    <div class="dashboard-card">
      <h3>Total Investido</h3>
      <p id="dashInvest">R$ 0,00</p>
      <small>Carteira de investimentos</small>
    </div>
    
    <div class="dashboard-card">
      <h3>Proventos Acumulados</h3>
      <p id="dashProv">R$ 0,00</p>
      <small>Renda passiva com recorr√™ncias</small>
    </div>
    
    <div class="dashboard-card">
      <h3>Empr√©stimos Ativos</h3>
      <p id="dashEmprestimos">R$ 0,00</p>
      <small>Valores em aberto</small>
    </div>
    
    <div class="dashboard-card">
      <h3>Patrim√¥nio Total</h3>
      <p id="dashPatrimonio">R$ 0,00</p>
      <small>Saldo + Investimentos + Empr√©stimos</small>
    </div>
  </div>
  
  <div class="data-table" style="margin-top: 30px;">
    <h3>Estat√≠sticas Gerais</h3>
    <table>
      <tr>
        <th style="cursor: default;">M√©trica</th>
        <th style="cursor: default;">Valor</th>
      </tr>
      <tr>
        <td><strong>Total de Receitas (com recorr√™ncias)</strong></td>
        <td id="totalReceitas"><strong>R$ 0,00</strong></td>
      </tr>
      <tr>
        <td><strong>Total de Despesas (com recorr√™ncias)</strong></td>
        <td id="totalDespesas"><strong>R$ 0,00</strong></td>
      </tr>
      <tr>
        <td>N√∫mero de Transa√ß√µes</td>
        <td id="numTransacoes">0</td>
      </tr>
      <tr>
        <td>N√∫mero de Investimentos</td>
        <td id="numInvestimentos">0</td>
      </tr>
      <tr>
        <td>N√∫mero de Empr√©stimos</td>
        <td id="numEmprestimos">0</td>
      </tr>
      <tr>
        <td>N√∫mero de Anota√ß√µes</td>
        <td id="numAnotacoes">0</td>
      </tr>
    </table>
  </div>
</div>

<!-- STATUS DE SINCRONIZA√á√ÉO -->
<div class="sync-status" id="syncStatus">
  <div class="spinner" id="syncSpinner"></div>
  <span id="syncMessage"></span>
</div>
<!-- ==================== M√ìDULO COMPARA√á√ÉO DE PER√çODOS ==================== -->
<div class="module-container" id="moduleComparacao">
  <div class="module-content">
    <div class="module-header">
      <h2>üìä Compara√ß√£o de Per√≠odos</h2>
      <button class="btn-close" onclick="closeModule('comparacao')">&times;</button>
    </div>
    <div class="module-body">
      
      <div class="alert alert-info">
        <span>‚ÑπÔ∏è</span>
        <span>Compare suas receitas e despesas entre diferentes per√≠odos</span>
      </div>
      
      <!-- SELE√á√ÉO DE PER√çODOS -->
      <div class="form-card">
        <h3>Selecione os Per√≠odos</h3>
        <div class="form-grid">
          <div class="form-group-inline">
            <label for="comp_periodo1">Per√≠odo 1 *</label>
            <input type="month" id="comp_periodo1" required>
          </div>
          <div class="form-group-inline">
            <label for="comp_periodo2">Per√≠odo 2 *</label>
            <input type="month" id="comp_periodo2" required>
          </div>
        </div>
        <button class="btn-primary" onclick="compararPeriodos()">Comparar Per√≠odos</button>
      </div>
      
      <!-- RESULTADOS DA COMPARA√á√ÉO -->
      <div id="comparisonResults" style="display: none;">
        <h3 style="margin: 30px 0 20px 0;">Resultado da Compara√ß√£o</h3>
        <div class="comparison-grid">
          <div class="comparison-card">
            <h4>üì• Receitas</h4>
            <div class="comparison-values">
              <span id="comp_rec_p1">R$ 0,00</span>
              <span id="comp_rec_p2">R$ 0,00</span>
            </div>
            <div class="comparison-values">
              <span>Diferen√ßa:</span>
              <span id="comp_rec_diff">R$ 0,00</span>
            </div>
          </div>
          
          <div class="comparison-card">
            <h4>üì§ Despesas</h4>
            <div class="comparison-values">
              <span id="comp_desp_p1">R$ 0,00</span>
              <span id="comp_desp_p2">R$ 0,00</span>
            </div>
            <div class="comparison-values">
              <span>Diferen√ßa:</span>
              <span id="comp_desp_diff">R$ 0,00</span>
            </div>
          </div>
          
          <div class="comparison-card">
            <h4>üí∞ Saldo</h4>
            <div class="comparison-values">
              <span id="comp_saldo_p1">R$ 0,00</span>
              <span id="comp_saldo_p2">R$ 0,00</span>
            </div>
            <div class="comparison-values">
              <span>Diferen√ßa:</span>
              <span id="comp_saldo_diff">R$ 0,00</span>
            </div>
          </div>
        </div>
        
        <!-- GR√ÅFICO DE COMPARA√á√ÉO -->
        <div class="chart-container" style="margin-top: 30px;">
          <canvas id="comparisonChart"></canvas>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- ==================== M√ìDULO GERENCIAR CATEGORIAS ==================== -->
<div class="module-container" id="moduleCategorias">
  <div class="module-content">
    <div class="module-header">
      <h2>üè∑Ô∏è Gerenciar Categorias</h2>
      <button class="btn-close" onclick="closeModule('categorias')">&times;</button>
    </div>
    <div class="module-body">
      
      <div class="alert alert-info">
        <span>‚ÑπÔ∏è</span>
        <span>Crie, edite ou exclua suas categorias personalizadas</span>
      </div>
      
      <!-- FORMUL√ÅRIO NOVA CATEGORIA -->
      <div class="form-card">
        <h3 id="catFormTitle">Nova Categoria</h3>
        <input type="hidden" id="cat_id">
        
        <div class="form-grid">
          <div class="form-group-inline">
            <label for="cat_nome">Nome da Categoria *</label>
            <input type="text" id="cat_nome" placeholder="Ex: Streaming, Pet, Viagens" required>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn-primary" id="btnSaveCat" onclick="saveCategoria()">Adicionar Categoria</button>
          <button class="btn-secondary" id="btnCancelCat" onclick="resetCatForm()" style="display:none">Cancelar</button>
        </div>
      </div>
      
      <!-- LISTA DE CATEGORIAS -->
      <div class="data-table">
        <h3>Categorias Padr√£o do Sistema</h3>
        <div id="defaultCategoriesList"></div>
      </div>
      
      <div class="data-table" style="margin-top: 30px;">
        <h3>Minhas Categorias Personalizadas</h3>
        <div id="customCategoriesList"></div>
      </div>
      
    </div>
  </div>
</div>

<!-- ==================== M√ìDULO METAS FINANCEIRAS ==================== -->
<div class="module-container" id="moduleMetas">
  <div class="module-content">
    <div class="module-header">
      <h2>üéØ Metas Financeiras</h2>
      <button class="btn-close" onclick="closeModule('metas')">&times;</button>
    </div>
    <div class="module-body">
      
      <div class="alert alert-info">
        <span>‚ÑπÔ∏è</span>
        <span>Defina metas e acompanhe seu progresso</span>
      </div>
      
      <!-- FORMUL√ÅRIO NOVA META -->
      <div class="form-card">
        <h3 id="metaFormTitle">Nova Meta Financeira</h3>
        <input type="hidden" id="meta_id">
        
        <div class="form-grid">
          <div class="form-group-inline">
            <label for="meta_titulo">T√≠tulo da Meta *</label>
            <input type="text" id="meta_titulo" placeholder="Ex: Viagem para Europa" required>
          </div>
          
          <div class="form-group-inline">
            <label for="meta_valor">Valor Objetivo (R$) *</label>
            <input type="text" id="meta_valor" placeholder="0,00" required>
          </div>
          
          <div class="form-group-inline">
            <label for="meta_atual">Valor Atual (R$)</label>
            <input type="text" id="meta_atual" placeholder="0,00">
          </div>
          
          <div class="form-group-inline">
            <label for="meta_prazo">Data Limite</label>
            <input type="date" id="meta_prazo">
          </div>
        </div>
        
        <div class="form-group-inline">
          <label for="meta_desc">Descri√ß√£o</label>
          <textarea id="meta_desc" rows="3" placeholder="Descreva sua meta..."></textarea>
        </div>
        
        <div class="action-buttons">
          <button class="btn-primary" id="btnSaveMeta" onclick="saveMeta()">Criar Meta</button>
          <button class="btn-secondary" id="btnCancelMeta" onclick="resetMetaForm()" style="display:none">Cancelar</button>
        </div>
      </div>
      
      <!-- LISTA DE METAS -->
      <div class="data-table">
        <h3>Minhas Metas</h3>
        <div id="metasList"></div>
      </div>
      
    </div>
  </div>
</div>

<!-- ==================== M√ìDULO OR√áAMENTO POR CATEGORIA ==================== -->
<div class="module-container" id="moduleOrcamento">
  <div class="module-content">
    <div class="module-header">
      <h2>üí∞ Or√ßamento por Categoria</h2>
      <button class="btn-close" onclick="closeModule('orcamento')">&times;</button>
    </div>
    <div class="module-body">
      
      <div class="alert alert-info">
        <span>‚ÑπÔ∏è</span>
        <span>Defina limites de gastos para cada categoria e acompanhe seu uso</span>
      </div>
      
      <!-- FORMUL√ÅRIO NOVO OR√áAMENTO -->
      <div class="form-card">
        <h3>Definir Or√ßamento</h3>
        
        <div class="form-grid">
          <div class="form-group-inline">
            <label for="orc_categoria">Categoria *</label>
            <select id="orc_categoria" required>
              <option value="">Selecione...</option>
            </select>
          </div>
          
          <div class="form-group-inline">
            <label for="orc_limite">Limite Mensal (R$) *</label>
            <input type="text" id="orc_limite" placeholder="0,00" required>
          </div>
          
          <div class="form-group-inline">
            <label for="orc_mes">M√™s de Refer√™ncia *</label>
            <input type="month" id="orc_mes" required>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn-primary" onclick="saveOrcamento()">Definir Or√ßamento</button>
        </div>
      </div>
      
      <!-- OR√áAMENTOS ATIVOS -->
      <div class="data-table">
        <h3>Or√ßamentos do M√™s Atual</h3>
        <div id="orcamentosList"></div>
      </div>
      
    </div>
  </div>
</div>

<!-- ==================== M√ìDULO PROJE√á√ÉO DE ATIVOS ==================== -->
<div class="module-container" id="moduleProjecao">
  <div class="module-content">
    <div class="module-header">
      <h2>üìä Proje√ß√£o de Crescimento de Ativos</h2>
      <button class="btn-close" onclick="closeModule('projecao')">&times;</button>
    </div>
    <div class="module-body">
      
      <div class="alert alert-info">
        <span>‚ÑπÔ∏è</span>
        <span>Simule o crescimento dos seus investimentos com base em rentabilidades hist√≥ricas m√©dias</span>
      </div>
      
      <!-- CONTROLES DE PROJE√á√ÉO -->
      <div class="projection-controls">
        <h3 style="color: #667eea; margin-bottom: 15px;">Per√≠odo de Proje√ß√£o</h3>
        
        <!-- SELE√á√ÉO DE PER√çODO -->
        <div class="projection-selector" id="projectionPeriodSelector">
          <!-- Meses -->
          <button class="projection-btn" onclick="selectProjectionPeriod(1, 'meses')">1 M√™s</button>
          <button class="projection-btn" onclick="selectProjectionPeriod(3, 'meses')">3 Meses</button>
          <button class="projection-btn" onclick="selectProjectionPeriod(6, 'meses')">6 Meses</button>
          <button class="projection-btn active" onclick="selectProjectionPeriod(12, 'meses')">12 Meses</button>
          
          <!-- Anos -->
          <button class="projection-btn" onclick="selectProjectionPeriod(1, 'anos')">1 Ano</button>
          <button class="projection-btn" onclick="selectProjectionPeriod(2, 'anos')">2 Anos</button>
          <button class="projection-btn" onclick="selectProjectionPeriod(5, 'anos')">5 Anos</button>
          <button class="projection-btn" onclick="selectProjectionPeriod(10, 'anos')">10 Anos</button>
          <button class="projection-btn" onclick="selectProjectionPeriod(20, 'anos')">20 Anos</button>
          <button class="projection-btn" onclick="selectProjectionPeriod(30, 'anos')">30 Anos</button>
        </div>
        
        <!-- PER√çODO PERSONALIZADO -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
          <h4 style="color: #333; margin-bottom: 10px;">Per√≠odo Personalizado</h4>
          <div class="form-grid">
            <div class="form-group-inline">
              <label for="customPeriod">Quantidade</label>
              <input type="number" id="customPeriod" min="1" placeholder="Ex: 15">
            </div>
            <div class="form-group-inline">
              <label for="customUnit">Unidade</label>
              <select id="customUnit">
                <option value="meses">Meses</option>
                <option value="anos">Anos</option>
              </select>
            </div>
          </div>
          <button class="btn-primary" onclick="applyCustomProjection()" style="margin-top: 10px;">Calcular Proje√ß√£o</button>
        </div>
      </div>
      
      <!-- RESULTADOS -->
      <div id="projectionResultsContainer"></div>
      
      <!-- GR√ÅFICO DE PROJE√á√ÉO -->
      <div class="projection-chart" id="projectionChartContainer" style="display: none;">
        <h3 style="color: #667eea; margin-bottom: 20px;">Evolu√ß√£o Projetada</h3>
        <div class="chart-container">
          <canvas id="projectionChart"></canvas>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- ==================== M√ìDULO FECHAMENTO MENSAL ==================== -->
<div class="module-container" id="moduleFechamento">
  <div class="module-content">
    <div class="module-header">
      <h2>üìÖ Fechamento Mensal</h2>
      <button class="btn-close" onclick="closeModule('fechamento')">&times;</button>
    </div>
    <div class="module-body">
      
      <div class="alert alert-info">
        <span>‚ÑπÔ∏è</span>
        <span>Visualize e feche a contabilidade de cada m√™s. Ap√≥s o fechamento, os dados ficam salvos como hist√≥rico.</span>
      </div>
      
      <!-- SELETOR DE M√äS -->
      <div class="form-card">
        <h3>Selecione o M√™s</h3>
        <div class="form-grid">
          <div class="form-group-inline">
            <label for="fechamento_mes">M√™s/Ano *</label>
            <input type="month" id="fechamento_mes" required>
          </div>
        </div>
        <div class="action-buttons">
          <button class="btn-primary" onclick="visualizarMes()">üìä Visualizar M√™s</button>
          <button class="btn-success" onclick="fecharMesAtual()">‚úì Fechar Este M√™s</button>
        </div>
      </div>
      
      <!-- DADOS DO M√äS SELECIONADO -->
      <div id="dadosMesSelecionado" style="display: none;">
        <h3 style="margin: 30px 0 20px 0; color: #333;">Dados do M√™s</h3>
        
        <div class="summary-grid">
          <div class="summary-card highlight">
            <h4>üí∞ Receitas</h4>
            <p id="fech_receitas">R$ 0,00</p>
          </div>
          <div class="summary-card danger">
            <h4>üí∏ Despesas</h4>
            <p id="fech_despesas">R$ 0,00</p>
          </div>
          <div class="summary-card">
            <h4>üìä Saldo</h4>
            <p id="fech_saldo">R$ 0,00</p>
          </div>
          <div class="summary-card warning">
            <h4>üìù Transa√ß√µes</h4>
            <p id="fech_num_trans">0</p>
          </div>
        </div>
        
        <!-- TABELA DE TRANSA√á√ïES DO M√äS -->
        <div class="data-table" style="margin-top: 20px;">
          <h3>Transa√ß√µes do M√™s</h3>
          <table id="tabelaTransacoesMes">
            <thead>
              <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Descri√ß√£o</th>
                <th>Categoria</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      
      

<script>
// ==================== CONFIGURA√á√ÉO ====================
// ==================== CONFIGURA√á√ÉO ====================
let SHEETS_URL = localStorage.getItem('sheetsUrl') || '';
let SPREADSHEET_URL = localStorage.getItem('spreadsheetUrl') || '';
let AUTO_SYNC_ENABLED = true; // Sincroniza√ß√£o autom√°tica habilitada

function salvarSheetsUrl() {
  const url = document.getElementById('sheetsUrlInput').value.trim();
  const spreadsheetUrl = document.getElementById('spreadsheetUrlInput').value.trim();
  
  if (!url) {
    alert('Por favor, insira a URL do Apps Script!');
    return;
  }
  
  if (!url.includes('script.google.com')) {
    alert('URL inv√°lida! Deve ser uma URL do Google Apps Script.');
    return;
  }
  
  SHEETS_URL = url;
  localStorage.setItem('sheetsUrl', url);
  
  if (spreadsheetUrl) {
    if (!spreadsheetUrl.includes('docs.google.com/spreadsheets')) {
      alert('‚ö†Ô∏è URL da planilha inv√°lida! Deve ser um link do Google Sheets.');
      return;
    }
    SPREADSHEET_URL = spreadsheetUrl;
    localStorage.setItem('spreadsheetUrl', spreadsheetUrl);
  }
  
  atualizarStatusUrl();
  atualizarLinkPlanilha();
  alert('‚úÖ Configura√ß√µes salvas com sucesso! A sincroniza√ß√£o autom√°tica est√° ativa.');
}

function atualizarStatusUrl() {
  const statusEl = document.getElementById('urlStatus');
  const inputEl = document.getElementById('sheetsUrlInput');
  const spreadsheetInput = document.getElementById('spreadsheetUrlInput');
  
  if (SHEETS_URL) {
    statusEl.textContent = '‚úÖ Configurado e ativo';
    statusEl.style.color = '#28a745';
    statusEl.style.fontWeight = 'bold';
    inputEl.value = SHEETS_URL;
    if (SPREADSHEET_URL) {
      spreadsheetInput.value = SPREADSHEET_URL;
    }
  } else {
    statusEl.textContent = '‚ùå N√£o configurado';
    statusEl.style.color = '#e74c3c';
    statusEl.style.fontWeight = 'bold';
  }
}

function atualizarLinkPlanilha() {
  const linkEl = document.getElementById('sheetLink');
  
  if (SPREADSHEET_URL) {
    linkEl.href = SPREADSHEET_URL;
    linkEl.style.display = 'block';
    linkEl.textContent = 'üìä Abrir Planilha no Google Sheets';
  } else {
    linkEl.style.display = 'none';
  }
}
// ==================== DADOS ====================
let usuario = JSON.parse(localStorage.getItem('usuario')) || null;
let financeiro = JSON.parse(localStorage.getItem('financeiro')) || [];
let investimentos = JSON.parse(localStorage.getItem('investimentos')) || [];
let consignacoes = JSON.parse(localStorage.getItem('consignacoes')) || [];
let anotacoes = JSON.parse(localStorage.getItem('anotacoes')) || [];
let vendas = JSON.parse(localStorage.getItem('vendas')) || [];
let consignacaoChart = null;
// NOVOS DADOS
let categorias = JSON.parse(localStorage.getItem('categorias')) || [];
let metas = JSON.parse(localStorage.getItem('metas')) || [];
let orcamentos = JSON.parse(localStorage.getItem('orcamentos')) || [];
let comparisonChart = null;
// ==================== SISTEMA DE FECHAMENTO MENSAL ====================
let fechamentosMensais = JSON.parse(localStorage.getItem('fechamentosMensais')) || [];
let mesSelecionado = null;
// ==================== CONTROLE DE VISUALIZA√á√ÉO DE PER√çODO ====================
let currentPeriodView = 'current'; // 'current' ou 'all'

function setPeriodView(view) {
  currentPeriodView = view;
  
  // Atualizar bot√µes ativos
  document.querySelectorAll('.period-toggle-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Atualizar display
  const displayText = view === 'current' ? 'M√™s Atual' : 'Todos os Meses';
  document.getElementById('currentPeriodDisplay').textContent = displayText;
  
  // Renderizar com a nova visualiza√ß√£o
  renderFinanceiro();
  renderFinanceiroCategorySummary();
}

// FUN√á√ÉO renderFinanceiro ATUALIZADA
function renderFinanceiro(filtered = null) {
  let data = filtered || financeiro;
  
  // APLICAR FILTRO DE PER√çODO apenas se n√£o houver filtro customizado
  if (!filtered && currentPeriodView === 'current') {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    data = financeiro.filter(item => {
      const itemDate = new Date(item.data);
      return itemDate.getMonth() === mesAtual && itemDate.getFullYear() === anoAtual;
    });
  }
  
  const table = document.getElementById('financeiroTable');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '';
  
  const sortedData = [...data].sort((a, b) => new Date(b.data) - new Date(a.data));
  
  sortedData.forEach(item => {
    const row = tbody.insertRow(-1);
    const dataFormatada = new Date(item.data).toLocaleString('pt-BR');
    
    const valorTotal = calculateRecurringValue(item.valor, item.data, item.recorrente);
    const occurrences = calculateRecurrenceOccurrences(item.data, item.recorrente);
    
    let recorrenciaInfo = item.recorrente;
    if (item.recorrente !== 'N√£o' && occurrences > 1) {
      recorrenciaInfo += ` (${occurrences}x = R$ ${displayCurrency(valorTotal)})`;
    }
    
    let badgeColor = '#d1ecf1';
    let textColor = '#0c5460';
    
    if (item.tipo === 'Recebido' || item.tipo === 'A Receber') {
      badgeColor = '#d4edda';
      textColor = '#155724';
    } else if (item.tipo === 'Pago' || item.tipo === 'Pagar') {
      badgeColor = '#f8d7da';
      textColor = '#721c24';
    }
    
    row.innerHTML = `
      <td>${dataFormatada}</td>
      <td><span style="padding: 4px 8px; border-radius: 4px; background: ${badgeColor}; color: ${textColor};">${item.tipo}</span></td>
      <td>${item.descricao}</td>
      <td>${item.categoria}</td>
      <td><strong>R$ ${displayCurrency(item.valor)}</strong></td>
      <td>${recorrenciaInfo}</td>
      <td>
        <button class="btn-edit" onclick="editFinanceiro(${item.id})">Editar</button>
        <button class="btn-delete" onclick="deleteFinanceiro(${item.id})">Excluir</button>
      </td>
    `;
  });
  
  // Mostrar mensagem se n√£o houver dados
  if (sortedData.length === 0) {
    const row = tbody.insertRow(-1);
    const mensagem = currentPeriodView === 'current' 
      ? 'Nenhuma transa√ß√£o neste m√™s' 
      : 'Nenhuma transa√ß√£o cadastrada';
    row.innerHTML = `<td colspan="7" style="text-align: center; padding: 20px; color: #999;">${mensagem}</td>`;
  }
}

// FUN√á√ÉO renderFinanceiroCategorySummary ATUALIZADA
function renderFinanceiroCategorySummary() {
  const summary = {};
  
  let dataToSummarize = financeiro;
  
  // APLICAR FILTRO DE PER√çODO
  if (currentPeriodView === 'current') {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    dataToSummarize = financeiro.filter(item => {
      const itemDate = new Date(item.data);
      return itemDate.getMonth() === mesAtual && itemDate.getFullYear() === anoAtual;
    });
  }
  
  dataToSummarize.forEach(item => {
    if (!summary[item.categoria]) {
      summary[item.categoria] = { total: 0, count: 0, occurrences: 0 };
    }
    
    const valorRecorrente = calculateRecurringValue(item.valor, item.data, item.recorrente);
    const occurrences = calculateRecurrenceOccurrences(item.data, item.recorrente);
    
    if (item.tipo === 'Pagar' || item.tipo === 'Pago') {
      summary[item.categoria].total -= valorRecorrente;
    } else {
      summary[item.categoria].total += valorRecorrente;
    }
    summary[item.categoria].count++;
    summary[item.categoria].occurrences += occurrences;
  });
  
  const container = document.getElementById('financeiroCategorySummary');
  container.innerHTML = '';
  
  // Atualizar t√≠tulo
  const hoje = new Date();
  const mesNome = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][hoje.getMonth()];
  const tituloAnterior = container.parentElement.querySelector('h3');
  if (tituloAnterior) {
    if (currentPeriodView === 'current') {
      tituloAnterior.textContent = `Resumo por Categoria - ${mesNome}/${hoje.getFullYear()}`;
    } else {
      tituloAnterior.textContent = `Resumo por Categoria - Todos os Per√≠odos`;
    }
  }
  
  if (Object.keys(summary).length === 0) {
    const mensagem = currentPeriodView === 'current' 
      ? 'Nenhuma transa√ß√£o neste m√™s' 
      : 'Nenhuma transa√ß√£o cadastrada';
    container.innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: #999; padding: 20px;">${mensagem}</p>`;
    return;
  }
  
  Object.keys(summary).sort().forEach(categoria => {
    const card = document.createElement('div');
    card.className = 'summary-card';
    if (summary[categoria].total < 0) {
      card.classList.add('danger');
    } else if (summary[categoria].total > 0) {
      card.classList.add('highlight');
    } else {
      card.classList.add('warning');
    }
    
    card.innerHTML = `
      <h4>${categoria}</h4>
      <p>R$ ${displayCurrency(Math.abs(summary[categoria].total))}</p>
      <small style="opacity: 0.8; font-size: 12px;">${summary[categoria].count} transa√ß√µes</small>
      <div class="recurrence-info">${summary[categoria].occurrences} ocorr√™ncias calculadas</div>
    `;
    container.appendChild(card);
  });
}

// FUN√á√ÉO renderDashboard ATUALIZADA
function renderDashboard() {
  let dataToAnalyze = financeiro;
  
  // APLICAR FILTRO DE PER√çODO (usar a mesma visualiza√ß√£o do m√≥dulo financeiro)
  if (currentPeriodView === 'current') {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    dataToAnalyze = financeiro.filter(item => {
      const itemDate = new Date(item.data);
      return itemDate.getMonth() === mesAtual && itemDate.getFullYear() === anoAtual;
    });
  }
  
  // Calcular valores DETALHADOS por tipo
  let receitasRecebidas = 0;
  let receitasAReceber = 0;
  let despesasPagas = 0;
  let despesasAPagar = 0;
  
  let totalRec = 0;
  let totalDesp = 0;
  
  dataToAnalyze.forEach(item => {
    const valorRecorrente = calculateRecurringValue(item.valor, item.data, item.recorrente);
    
    // RECEITAS
    if (item.tipo === 'Recebido') {
      receitasRecebidas += valorRecorrente;
      totalRec += valorRecorrente;
    } else if (item.tipo === 'A Receber') {
      receitasAReceber += valorRecorrente;
      totalRec += valorRecorrente;
    }
    
    // DESPESAS
    else if (item.tipo === 'Pago') {
      despesasPagas += valorRecorrente;
      totalDesp += valorRecorrente;
    } else if (item.tipo === 'Pagar') {
      despesasAPagar += valorRecorrente;
      totalDesp += valorRecorrente;
    }
  });
  
  // SALDO L√çQUIDO = Total Receitas - Total Despesas
  const saldoLiquido = totalRec - totalDesp;
  const saldo = totalRec - totalDesp;
  
  // Investimentos (sempre todos)
  let totalInvest = 0;
  let totalProv = 0;
  
  investimentos.forEach(item => {
    totalInvest += item.valor;
    const proventoRecorrente = calculateRecurringValue(item.provento, item.data, item.recorrente);
    totalProv += proventoRecorrente;
  });
  
  // Empr√©stimos (sempre todos)
  let totalEmprestimos = 0;
  consignacoes.forEach(item => {
    totalEmprestimos += (item.total - item.pago);
  });
  
  const patrimonio = saldo + totalInvest + totalEmprestimos;
  
  // ATUALIZAR NOVOS CARDS
  document.getElementById('dashReceitasRecebidas').textContent = 'R$ ' + displayCurrency(receitasRecebidas);
  document.getElementById('dashReceitasAReceber').textContent = 'R$ ' + displayCurrency(receitasAReceber);
  document.getElementById('dashDespesasPagas').textContent = 'R$ ' + displayCurrency(despesasPagas);
  document.getElementById('dashDespesasAPagar').textContent = 'R$ ' + displayCurrency(despesasAPagar);
  
  // Colorir o saldo l√≠quido
  const saldoLiquidoEl = document.getElementById('dashSaldoLiquido');
  saldoLiquidoEl.textContent = 'R$ ' + displayCurrency(Math.abs(saldoLiquido));
  if (saldoLiquido >= 0) {
    saldoLiquidoEl.style.color = '#28a745';
  } else {
    saldoLiquidoEl.style.color = '#e74c3c';
    saldoLiquidoEl.textContent = '- R$ ' + displayCurrency(Math.abs(saldoLiquido));
  }
  
  // ATUALIZAR CARDS ORIGINAIS
  document.getElementById('dashSaldo').textContent = 'R$ ' + displayCurrency(saldo);
  document.getElementById('dashInvest').textContent = 'R$ ' + displayCurrency(totalInvest);
  document.getElementById('dashProv').textContent = 'R$ ' + displayCurrency(totalProv);
  document.getElementById('dashEmprestimos').textContent = 'R$ ' + displayCurrency(totalEmprestimos);
  document.getElementById('dashPatrimonio').textContent = 'R$ ' + displayCurrency(patrimonio);
  
  document.getElementById('totalReceitas').textContent = 'R$ ' + displayCurrency(totalRec);
  document.getElementById('totalDespesas').textContent = 'R$ ' + displayCurrency(totalDesp);
  document.getElementById('numTransacoes').textContent = dataToAnalyze.length;
  document.getElementById('numInvestimentos').textContent = investimentos.length;
  document.getElementById('numEmprestimos').textContent = consignacoes.length;
  document.getElementById('numAnotacoes').textContent = anotacoes.length;
}

// Fun√ß√£o para obter o m√™s/ano atual no formato YYYY-MM
function getMesAtual() {
  const hoje = new Date();
  return `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
}

// Fun√ß√£o para calcular totais de um m√™s espec√≠fico
function calcularTotaisMes(mesAno) {
  const [ano, mes] = mesAno.split('-');
  let receitas = 0;
  let despesas = 0;
  let transacoes = [];
  
  financeiro.forEach(item => {
    const itemDate = new Date(item.data);
    if (itemDate.getFullYear() === parseInt(ano) && itemDate.getMonth() + 1 === parseInt(mes)) {
      const valorRecorrente = calculateRecurringValue(item.valor, item.data, item.recorrente);
      
      transacoes.push({
        ...item,
        valorCalculado: valorRecorrente
      });
      
      if (item.tipo === 'Recebido' || item.tipo === 'A Receber') {
        receitas += valorRecorrente;
      } else {
        despesas += valorRecorrente;
      }
    }
  });
  
  return {
    mesAno,
    receitas,
    despesas,
    saldo: receitas - despesas,
    transacoes
  };
}

// Fun√ß√£o para fechar o m√™s
function fecharMes(mesAno) {
  const jaFechado = fechamentosMensais.find(f => f.mesAno === mesAno);
  
  if (jaFechado) {
    if (!confirm(`O m√™s ${mesAno} j√° foi fechado. Deseja refazer o fechamento?`)) {
      return;
    }
    // Remover fechamento anterior
    fechamentosMensais = fechamentosMensais.filter(f => f.mesAno !== mesAno);
  }
  
  const totais = calcularTotaisMes(mesAno);
  
  const fechamento = {
    id: Date.now(),
    mesAno: mesAno,
    dataFechamento: new Date().toISOString(),
    receitas: totais.receitas,
    despesas: totais.despesas,
    saldo: totais.saldo,
    numTransacoes: totais.transacoes.length,
    transacoes: totais.transacoes
  };
  
  fechamentosMensais.push(fechamento);
  localStorage.setItem('fechamentosMensais', JSON.stringify(fechamentosMensais));
  
  return fechamento;
}

// Fun√ß√£o para obter meses dispon√≠veis
function getMesesDisponiveis() {
  const meses = new Set();
  
  financeiro.forEach(item => {
    const data = new Date(item.data);
    const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
    meses.add(mesAno);
  });
  
  return Array.from(meses).sort().reverse();
}

// CATEGORIAS PADR√ÉO DO SISTEMA
const categoriasDefault = ['Sal√°rio', 'Alimenta√ß√£o', 'Transporte', 'Moradia', 'Sa√∫de', 'Educa√ß√£o', 'Lazer', 'Investimentos', 'Outros'];

// ==================== SINCRONIZA√á√ÉO AUTOM√ÅTICA ====================
// SINCRONIZA√á√ÉO AUTOM√ÅTICA - Envia para Sheets ap√≥s salvar
async function syncToSheetsAuto(tipo, data) {
  if (!SHEETS_URL || !AUTO_SYNC_ENABLED) return;
  
  try {
    let sheetName;
    
    switch(tipo) {
      case 'financeiro':
        sheetName = 'Financeiro';
        break;
      case 'investimentos':
        sheetName = 'Investimentos';
        break;
      case 'consignacoes':
        sheetName = 'Consignacao';
        break;
      case 'anotacoes':
        sheetName = 'Anotacoes';
        break;
      case 'vendas':
        sheetName = 'Vendas';
        break;
      default:
        return;
    }
    
    const response = await fetch(SHEETS_URL + '?action=write', {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain',
      },
      body: JSON.stringify({
        sheet: sheetName,
        data: data
      })
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      console.log('‚úÖ Sincronizado automaticamente:', tipo);
    }
    
  } catch (error) {
    console.error('‚ö†Ô∏è Erro na sincroniza√ß√£o autom√°tica:', error);
  }
}
// ==================== FUN√á√ïES DE SINCRONIZA√á√ÉO ====================
function showSyncStatus(message, type = 'syncing') {
  const status = document.getElementById('syncStatus');
  const spinner = document.getElementById('syncSpinner');
  const messageEl = document.getElementById('syncMessage');
  
  status.className = 'sync-status show ' + type;
  messageEl.textContent = message;
  
  if (type === 'syncing') {
    spinner.style.display = 'block';
  } else {
    spinner.style.display = 'none';
  }
  
  if (type !== 'syncing') {
    setTimeout(() => {
      status.classList.remove('show');
    }, 3000);
  }
}

async function syncToSheets(tipo) {
  if (!SHEETS_URL) {
    alert('‚ö†Ô∏è Configure primeiro a URL do Google Sheets nas Configura√ß√µes!');
    return;
  }
  
  showSyncStatus('Sincronizando dados...', 'syncing');
  
  try {
    let data;
    let sheetName;
    
    switch(tipo) {
      case 'financeiro':
        data = financeiro;
        sheetName = 'Financeiro';
        break;
      case 'investimentos':
        data = investimentos;
        sheetName = 'Investimentos';
        break;
      case 'consignacoes':
        data = consignacoes;
        sheetName = 'Consignacao';
        break;
      case 'anotacoes':
        data = anotacoes;
        sheetName = 'Anotacoes';
        break;
      case 'vendas':
        data = vendas;
        sheetName = 'Vendas';
        break;
      default:
        throw new Error('Tipo de dados inv√°lido');
    }
    
    const response = await fetch(SHEETS_URL + '?action=write', {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain',
      },
      body: JSON.stringify({
        sheet: sheetName,
        data: data
      })
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      showSyncStatus('‚úì Dados sincronizados com sucesso!', 'success');
      console.log('Sincroniza√ß√£o conclu√≠da:', tipo);
    } else {
      throw new Error(result.message || 'Erro desconhecido');
    }
    
  } catch (error) {
    console.error('Erro ao sincronizar:', error);
    showSyncStatus('‚úó Erro na sincroniza√ß√£o: ' + error.message, 'error');
  }
}

async function loadFromSheets(tipo) {
  if (!SHEETS_URL) {
    alert('‚ö†Ô∏è Configure primeiro a URL do Google Sheets nas Configura√ß√µes!');
    return;
  }
  
  showSyncStatus('Carregando dados do Sheets...', 'syncing');
  
  try {
    let sheetName;
    
    switch(tipo) {
      case 'financeiro':
        sheetName = 'Financeiro';
        break;
      case 'investimentos':
        sheetName = 'Investimentos';
        break;
      case 'consignacoes':
        sheetName = 'Consignacao';
        break;
      case 'anotacoes':
        sheetName = 'Anotacoes';
        break;
      case 'vendas':
        sheetName = 'Vendas';
        break;
      default:
        throw new Error('Tipo de dados inv√°lido');
    }
    
    const response = await fetch(`${SHEETS_URL}?action=read&sheet=${sheetName}`);
    const result = await response.json();
    
    if (result.status === 'success' && result.data) {
      switch(tipo) {
        case 'financeiro':
          financeiro = result.data;
          localStorage.setItem('financeiro', JSON.stringify(financeiro));
          renderFinanceiro();
          renderFinanceiroCategorySummary();
          break;
        case 'investimentos':
          investimentos = result.data;
          localStorage.setItem('investimentos', JSON.stringify(investimentos));
          renderInvestimentos();
          renderInvestimentoModalitySummary();
          break;
        case 'consignacoes':
          consignacoes = result.data;
          localStorage.setItem('consignacoes', JSON.stringify(consignacoes));
          renderConsignacoes();
          renderConsignacaoSummary();
          renderConsignacaoChart();
          break;
        case 'anotacoes':
          anotacoes = result.data;
          localStorage.setItem('anotacoes', JSON.stringify(anotacoes));
          renderAnotacoes();
          renderAnotacoesPrioritySummary();
          break;
        case 'vendas':
          vendas = result.data;
          localStorage.setItem('vendas', JSON.stringify(vendas));
          renderVendas();
          break;
      }
      
      showSyncStatus('‚úì Dados carregados com sucesso!', 'success');
    } else {
      throw new Error(result.message || 'Erro ao carregar dados');
    }
    
  } catch (error) {
    console.error('Erro ao carregar do Sheets:', error);
    showSyncStatus('‚úó Erro ao carregar dados: ' + error.message, 'error');
  }
}

// ==================== C√ÅLCULO DE RECORR√äNCIAS ====================
function calculateRecurrenceOccurrences(startDate, recurrence) {
  if (!startDate || recurrence === 'N√£o') return 1;
  
  const start = new Date(startDate);
  const today = new Date();
  
  if (start > today) {
    return 1;
  }
  
  const diffTime = Math.abs(today - start);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  switch(recurrence) {
    case 'Di√°rio':
      return diffDays + 1;
    case 'Mensal':
      const months = (today.getFullYear() - start.getFullYear()) * 12 + (today.getMonth() - start.getMonth());
      return Math.max(1, months + 1);
    case 'Bimestral':
      const bimesters = Math.floor(((today.getFullYear() - start.getFullYear()) * 12 + (today.getMonth() - start.getMonth())) / 2);
      return Math.max(1, bimesters + 1);
    case 'Trimestral':
      const quarters = Math.floor(((today.getFullYear() - start.getFullYear()) * 12 + (today.getMonth() - start.getMonth())) / 3);
      return Math.max(1, quarters + 1);
    case 'Semestral':
      const semesters = Math.floor(((today.getFullYear() - start.getFullYear()) * 12 + (today.getMonth() - start.getMonth())) / 6);
      return Math.max(1, semesters + 1);
    case 'Anual':
      const years = today.getFullYear() - start.getFullYear();
      return Math.max(1, years + 1);
    default:
      return 1;
  }
}

function calculateRecurringValue(value, startDate, recurrence) {
  if (recurrence === 'N√£o' || !recurrence) {
    return value;
  }
  
  const occurrences = calculateRecurrenceOccurrences(startDate, recurrence);
  return value * occurrences;
}

// ==================== FORMATA√á√ÉO DE MOEDA ====================
function formatCurrency(input) {
  let value = input.value.replace(/\D/g, '');
  value = (value / 100).toFixed(2);
  value = value.replace('.', ',');
  value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
  input.value = value;
}

function parseCurrency(value) {
  if (typeof value === 'number') return value;
  if (!value) return 0;
  return parseFloat(value.replace(/\./g, '').replace(',', '.')) || 0;
}

function displayCurrency(value) {
  return new Intl.NumberFormat('pt-BR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(value);
}

// ==================== INICIALIZA√á√ÉO ====================
window.onload = function() {
  // Carregar tema primeiro
  loadThemePreference();
  
  // Carregar URLs salvas
  SPREADSHEET_URL = localStorage.getItem('spreadsheetUrl') || '';
  
  // Configurar URL automaticamente
  if (!SHEETS_URL) {
    SHEETS_URL = 'https://script.google.com/macros/s/AKfycbys-sSZ-GMiS4_yEe_lM2T0nVXRypnxT0HX3dc0cAYkks2Pd1hG5XalOiTHDHi1Q3Invg/exec';
    localStorage.setItem('sheetsUrl', SHEETS_URL);
  }
  
  if (usuario) {
    mostrarTelaPrincipal();
    atualizarLinkPlanilha();
    autoLoadAllData();
  }
  
  atualizarStatusUrl();
  
  // Adicionar formata√ß√£o de moeda aos campos ORIGINAIS
  const currencyInputs = ['f_valor', 'i_valor', 'i_prov', 'c_valor', 'v_custo', 'v_valor'];
  currencyInputs.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('input', function() {
        formatCurrency(this);
      });
    }
  });
  
  // NOVO: Adicionar formata√ß√£o aos campos dos novos m√≥dulos
  const newCurrencyInputs = ['meta_valor', 'meta_atual', 'orc_limite'];
  newCurrencyInputs.forEach(id => {
    const input = document.getElementById(id);
    if (input) {
      input.addEventListener('input', function() {
        formatCurrency(this);
      });
    }
  });
  
  // NOVO: Inicializar categorias personalizadas
  updateCategorySelects();
  
  // Fecha m√≥dulos com ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const activeModule = document.querySelector('.module-container.active');
      if (activeModule) {
        const moduleId = activeModule.id.replace('module', '').toLowerCase();
        closeModule(moduleId);
      }
    }
  });
};

// ==================== FECHAR M√ìDULOS (CORRIGIDO) ====================
function closeModule(module) {
  // Normalizar o nome do m√≥dulo
  const moduleName = module.toLowerCase().replace(/[^a-z]/g, '');
  
  // Lista de IDs de m√≥dulos v√°lidos
 const moduleIds = {
  'configuracao': 'moduleConfiguracao',
  'financeiro': 'moduleFinanceiro',
  'investimento': 'moduleInvestimento',
  'consignacao': 'moduleConsignacao',
  'anotacoes': 'moduleAnotacoes',
  'vendas': 'moduleVendas',
  'dashboard': 'moduleDashboard',
  'comparacao': 'moduleComparacao',
  'categorias': 'moduleCategorias',
  'metas': 'moduleMetas',
  'orcamento': 'moduleOrcamento',
  'projecao': 'moduleProjecao', // ‚Üê ADICIONE ESTA LINHA
  'fechamento': 'moduleFechamento'
};
  
  // Obter o ID correto do m√≥dulo
  const moduleId = moduleIds[moduleName];
  
  if (moduleId) {
    const moduleElement = document.getElementById(moduleId);
    if (moduleElement) {
      moduleElement.classList.remove('active');
      
      // Resetar formul√°rios espec√≠ficos
      if (moduleName === 'financeiro') resetFinForm();
      if (moduleName === 'investimento') resetInvForm();
      if (moduleName === 'consignacao') resetConsForm();
      if (moduleName === 'anotacoes') resetAnotForm();
      if (moduleName === 'vendas') limparFormVendas();
      
      console.log('‚úÖ M√≥dulo fechado:', moduleName);
    } else {
      console.error('‚ùå Elemento do m√≥dulo n√£o encontrado:', moduleId);
    }
  } else {
    console.error('‚ùå M√≥dulo n√£o reconhecido:', moduleName);
  }
}

// ==================== CARREGAMENTO AUTOM√ÅTICO ====================
async function autoLoadAllData() {
  if (!SHEETS_URL) return;
  
  console.log('üîÑ Carregando dados do Google Sheets...');
  
  try {
    // Carregar Financeiro
    const finResponse = await fetch(`${SHEETS_URL}?action=read&sheet=Financeiro`);
    const finResult = await finResponse.json();
    if (finResult.status === 'success' && finResult.data && finResult.data.length > 0) {
      financeiro = finResult.data;
      localStorage.setItem('financeiro', JSON.stringify(financeiro));
      console.log('‚úÖ Financeiro carregado:', financeiro.length, 'registros');
    }
  } catch (e) {
    console.log('‚ö†Ô∏è Erro ao carregar Financeiro:', e.message);
  }
  
  try {
    // Carregar Investimentos
    const invResponse = await fetch(`${SHEETS_URL}?action=read&sheet=Investimentos`);
    const invResult = await invResponse.json();
    if (invResult.status === 'success' && invResult.data && invResult.data.length > 0) {
      investimentos = invResult.data;
      localStorage.setItem('investimentos', JSON.stringify(investimentos));
      console.log('‚úÖ Investimentos carregado:', investimentos.length, 'registros');
    }
  } catch (e) {
    console.log('‚ö†Ô∏è Erro ao carregar Investimentos:', e.message);
  }
  
  try {
    // Carregar Consigna√ß√£o
    const consResponse = await fetch(`${SHEETS_URL}?action=read&sheet=Consignacao`);
    const consResult = await consResponse.json();
    if (consResult.status === 'success' && consResult.data && consResult.data.length > 0) {
      consignacoes = consResult.data;
      localStorage.setItem('consignacoes', JSON.stringify(consignacoes));
      console.log('‚úÖ Consigna√ß√£o carregado:', consignacoes.length, 'registros');
    }
  } catch (e) {
    console.log('‚ö†Ô∏è Erro ao carregar Consigna√ß√£o:', e.message);
  }
  
  try {
    // Carregar Anota√ß√µes
    const anotResponse = await fetch(`${SHEETS_URL}?action=read&sheet=Anotacoes`);
    const anotResult = await anotResponse.json();
    if (anotResult.status === 'success' && anotResult.data && anotResult.data.length > 0) {
      anotacoes = anotResult.data;
      localStorage.setItem('anotacoes', JSON.stringify(anotacoes));
      console.log('‚úÖ Anota√ß√µes carregado:', anotacoes.length, 'registros');
    }
  } catch (e) {
    console.log('‚ö†Ô∏è Erro ao carregar Anota√ß√µes:', e.message);
  }
  
  try {
    // Carregar Vendas
    const vendasResponse = await fetch(`${SHEETS_URL}?action=read&sheet=Vendas`);
    const vendasResult = await vendasResponse.json();
    if (vendasResult.status === 'success' && vendasResult.data && vendasResult.data.length > 0) {
      vendas = vendasResult.data;
      localStorage.setItem('vendas', JSON.stringify(vendas));
      console.log('‚úÖ Vendas carregado:', vendas.length, 'registros');
    }
  } catch (e) {
    console.log('‚ö†Ô∏è Erro ao carregar Vendas:', e.message);
  }
  
  console.log('‚úÖ Carregamento autom√°tico conclu√≠do!');
}
// ==================== SINCRONIZA√á√ÉO EM MASSA ====================
async function syncAllToSheets() {
  if (!SHEETS_URL) {
    alert('‚ö†Ô∏è Configure a URL do Google Sheets primeiro!');
    return;
  }
  
  if (!confirm('Deseja enviar TODOS os dados para o Google Sheets?')) {
    return;
  }
  
  showSyncStatus('Enviando todos os dados...', 'syncing');
  
  let sucessos = 0;
  let erros = 0;
  
  // Sincronizar cada m√≥dulo
  const modulos = [
    { tipo: 'financeiro', data: financeiro, nome: 'Financeiro' },
    { tipo: 'investimentos', data: investimentos, nome: 'Investimentos' },
    { tipo: 'consignacoes', data: consignacoes, nome: 'Consignacao' },
    { tipo: 'anotacoes', data: anotacoes, nome: 'Anotacoes' },
    { tipo: 'vendas', data: vendas, nome: 'Vendas' }
  ];
  
  for (const mod of modulos) {
    try {
      const response = await fetch(SHEETS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ sheet: mod.nome, data: mod.data })
      });
      
      const result = await response.json();
      
      if (result.status === 'success') {
        sucessos++;
        console.log(`‚úÖ ${mod.tipo} sincronizado`);
      } else {
        erros++;
        console.error(`‚ùå Erro em ${mod.tipo}:`, result.message);
      }
    } catch (error) {
      erros++;
      console.error(`‚ùå Erro em ${mod.tipo}:`, error);
    }
  }
  
  if (erros === 0) {
    showSyncStatus(`‚úÖ Todos os dados foram sincronizados! (${sucessos} m√≥dulos)`, 'success');
  } else {
    showSyncStatus(`‚ö†Ô∏è Sincroniza√ß√£o parcial: ${sucessos} OK, ${erros} com erro`, 'error');
  }
}

async function loadAllFromSheets() {
  if (!SHEETS_URL) {
    alert('‚ö†Ô∏è Configure a URL do Google Sheets primeiro!');
    return;
  }
  
  if (!confirm('Deseja carregar TODOS os dados do Google Sheets? Isso substituir√° os dados locais.')) {
    return;
  }
  
  showSyncStatus('Carregando todos os dados...', 'syncing');
  
  await autoLoadAllData();
  
  showSyncStatus('‚úÖ Todos os dados foram carregados!', 'success');
  alert('‚úÖ Dados carregados com sucesso! Abra qualquer m√≥dulo para ver.');
}

// ==================== LOGIN ====================
function fazerLogin(event) {
  event.preventDefault();
  
  const nome = document.getElementById('loginNome').value.trim();
  if (!nome) {
    alert('Por favor, preencha o nome!');
    return;
  }
  
  usuario = {
    nome: nome,
    email: document.getElementById('loginEmail').value
  };
  
  localStorage.setItem('usuario', JSON.stringify(usuario));
  mostrarTelaPrincipal();
}

function mostrarTelaPrincipal() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainScreen').classList.add('active');
  document.getElementById('userName').textContent = `Ol√°, ${usuario.nome}!`;
  atualizarLinkPlanilha();
  autoLoadAllData();
}

function fazerLogout() {
  if (confirm('Deseja realmente sair do sistema?')) {
    document.getElementById('mainScreen').classList.remove('active');
    document.getElementById('loginScreen').style.display = 'block';
  }
}

// ==================== M√ìDULOS ====================
function openModule(module) {
  document.getElementById('module' + module.charAt(0).toUpperCase() + module.slice(1)).classList.add('active');
  
  if (module === 'financeiro') {
    renderFinanceiro();
    renderFinanceiroCategorySummary();
  }
  if (module === 'investimento') {
    renderInvestimentos();
    renderInvestimentoModalitySummary();
  }
  if (module === 'consignacao') {
    renderConsignacoes();
    renderConsignacaoSummary();
    renderConsignacaoChart();
  }
  if (module === 'anotacoes') {
    renderAnotacoes();
    renderAnotacoesPrioritySummary();
  }
  if (module === 'vendas') {
    renderVendas();
  }
  if (module === 'dashboard') {
    renderDashboard();
  }
  if (module === 'configuracao') {
    atualizarStatusUrl();
  }
  
  // NOVOS M√ìDULOS
  if (module === 'comparacao') {
    const hoje = new Date();
    const mesAtual = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
    const mesAnterior = `${hoje.getFullYear()}-${String(hoje.getMonth()).padStart(2, '0')}`;
    document.getElementById('comp_periodo1').value = mesAnterior;
    document.getElementById('comp_periodo2').value = mesAtual;
  }
  if (module === 'categorias') {
    renderCategorias();
  }
  if (module === 'metas') {
    renderMetas();
  }
  if (module === 'orcamento') {
    updateCategorySelects();
    renderOrcamentos();
    const hoje = new Date();
    const mesAtual = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
    document.getElementById('orc_mes').value = mesAtual;
  }
  // ADICIONE DENTRO DA FUN√á√ÉO openModule, ap√≥s os outros m√≥dulos:

if (module === 'projecao') {
  if (investimentos.length === 0) {
    alert('‚ö†Ô∏è Voc√™ ainda n√£o tem investimentos cadastrados!\n\nCadastre alguns investimentos primeiro para ver as proje√ß√µes.');
    closeModule('projecao');
    return;
  }
  calculateProjections();
}
if (module === 'fechamento') {
  const hoje = new Date();
  const mesAtual = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
  document.getElementById('fechamento_mes').value = mesAtual;
  renderHistoricoFechamentos();
}
}

// (Aqui voc√™ deve incluir todo o resto do JavaScript original do sistema)
// As fun√ß√µes de saveFinanceiro, renderFinanceiro, editFinanceiro, deleteFinanceiro, etc.
// Por brevidade, n√£o vou repetir todo o c√≥digo, mas todas as fun√ß√µes originais devem estar aqui

// ==================== FINANCEIRO ====================
function saveFinanceiro() {
  const id = document.getElementById('f_id').value;
  const item = {
    id: id ? parseInt(id) : Date.now(),
    data: document.getElementById('f_data').value,
    tipo: document.getElementById('f_tipo').value,
    valor: parseCurrency(document.getElementById('f_valor').value),
    descricao: document.getElementById('f_desc').value,
    categoria: document.getElementById('f_cat').value,
    recorrente: document.getElementById('f_rec').value
  };
  
  if (!item.data || !item.descricao || item.valor === 0) {
    alert('Preencha todos os campos obrigat√≥rios!');
    return;
  }
  
  if (id) {
    const index = financeiro.findIndex(f => f.id === item.id);
    financeiro[index] = item;
  } else {
    financeiro.push(item);
  }
  
  localStorage.setItem('financeiro', JSON.stringify(financeiro));
  syncToSheetsAuto('financeiro', financeiro);
  resetFinForm();
  renderFinanceiro();
  renderFinanceiroCategorySummary();
}


function editFinanceiro(id) {
  const item = financeiro.find(f => f.id === id);
  document.getElementById('f_id').value = item.id;
  document.getElementById('f_data').value = item.data;
  document.getElementById('f_tipo').value = item.tipo;
  document.getElementById('f_valor').value = displayCurrency(item.valor);
  document.getElementById('f_desc').value = item.descricao;
  document.getElementById('f_cat').value = item.categoria;
  document.getElementById('f_rec').value = item.recorrente;
  
  document.getElementById('finFormTitle').textContent = "Editando Transa√ß√£o";
  document.getElementById('btnSaveFin').textContent = "Salvar Altera√ß√µes";
  document.getElementById('btnCancelFin').style.display = "inline-block";
  document.getElementById('formFinanceiro').classList.add('editing');
  
  document.getElementById('formFinanceiro').scrollIntoView({behavior: 'smooth', block: 'start'});
}

function resetFinForm() {
  document.getElementById('f_id').value = "";
  document.getElementById('f_data').value = "";
  document.getElementById('f_valor').value = "";
  document.getElementById('f_desc').value = "";
  document.getElementById('f_cat').selectedIndex = 0;
  document.getElementById('f_rec').selectedIndex = 0;
  document.getElementById('finFormTitle').textContent = "Nova Transa√ß√£o";
  document.getElementById('btnSaveFin').textContent = "Adicionar Transa√ß√£o";
  document.getElementById('btnCancelFin').style.display = "none";
  document.getElementById('formFinanceiro').classList.remove('editing');
}

function deleteFinanceiro(id) {
  if (confirm('Deseja realmente excluir esta transa√ß√£o?')) {
    financeiro = financeiro.filter(item => item.id !== id);
    localStorage.setItem('financeiro', JSON.stringify(financeiro));
    syncToSheetsAuto('financeiro', financeiro);
    renderFinanceiro();
    renderFinanceiroCategorySummary();
  }
}



function applyFinanceiroFilters() {
  const dataInicio = document.getElementById('filterFinDataInicio').value;
  const dataFim = document.getElementById('filterFinDataFim').value;
  const tipo = document.getElementById('filterFinTipo').value;
  const categoria = document.getElementById('filterFinCategoria').value;
  
  const filtered = financeiro.filter(item => {
    const itemDate = new Date(item.data);
    let match = true;
    
    if (dataInicio && itemDate < new Date(dataInicio)) match = false;
    if (dataFim && itemDate > new Date(dataFim + 'T23:59:59')) match = false;
    if (tipo && item.tipo !== tipo) match = false;
    if (categoria && item.categoria !== categoria) match = false;
    
    return match;
  });
  
  renderFinanceiro(filtered);
  alert(`Encontrados ${filtered.length} resultado(s)`);
}

function clearFinanceiroFilters() {
  document.getElementById('filterFinDataInicio').value = '';
  document.getElementById('filterFinDataFim').value = '';
  document.getElementById('filterFinTipo').value = '';
  document.getElementById('filterFinCategoria').value = '';
  renderFinanceiro();
}

// ==================== INVESTIMENTOS ====================
function saveInvestimento() {
  const id = document.getElementById('i_id').value;
  const item = {
    id: id ? parseInt(id) : Date.now(),
    ativo: document.getElementById('i_ativo').value,
    modalidade: document.getElementById('i_mod').value,
    data: document.getElementById('i_data').value,
    valor: parseCurrency(document.getElementById('i_valor').value),
    quantidade: parseFloat(document.getElementById('i_qtd').value) || 0,
    provento: parseCurrency(document.getElementById('i_prov').value),
    recorrente: document.getElementById('i_rec').value
  };
  
  if (!item.ativo || item.valor === 0) {
    alert('Preencha os campos obrigat√≥rios!');
    return;
  }
  
  if (id) {
    const index = investimentos.findIndex(i => i.id === item.id);
    investimentos[index] = item;
  } else {
    investimentos.push(item);
  }
  
  localStorage.setItem('investimentos', JSON.stringify(investimentos));
  syncToSheetsAuto('investimentos', investimentos);
  resetInvForm();
  renderInvestimentos();
  renderInvestimentoModalitySummary();
}

function renderInvestimentos(filtered = null) {
  const data = filtered || investimentos;
  const table = document.getElementById('investTable');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '';
  
  const sortedData = [...data].sort((a, b) => a.ativo.localeCompare(b.ativo));
  
  sortedData.forEach(item => {
    const row = tbody.insertRow(-1);
    
    const proventoTotal = calculateRecurringValue(item.provento, item.data, item.recorrente);
    const occurrences = calculateRecurrenceOccurrences(item.data, item.recorrente);
    
    let recorrenciaInfo = item.recorrente || 'N√£o';
    if (item.recorrente && item.recorrente !== 'N√£o' && item.provento > 0 && occurrences > 1) {
      recorrenciaInfo += ` (${occurrences}x = R$ ${displayCurrency(proventoTotal)})`;
    }
    
    row.innerHTML = `
      <td><strong>${item.ativo}</strong></td>
      <td>${item.modalidade}</td>
      <td>R$ ${displayCurrency(item.valor)}</td>
      <td>${item.quantidade > 0 ? item.quantidade : '-'}</td>
      <td>R$ ${displayCurrency(item.provento)}</td>
      <td>${recorrenciaInfo}</td>
      <td>
        <button class="btn-edit" onclick="editInvestimento(${item.id})">Editar</button>
        <button class="btn-delete" onclick="deleteInvestimento(${item.id})">Excluir</button>
      </td>
    `;
  });
}

function editInvestimento(id) {
  const item = investimentos.find(i => i.id === id);
  document.getElementById('i_id').value = item.id;
  document.getElementById('i_ativo').value = item.ativo;
  document.getElementById('i_mod').value = item.modalidade;
  document.getElementById('i_data').value = item.data || '';
  document.getElementById('i_valor').value = displayCurrency(item.valor);
  document.getElementById('i_qtd').value = item.quantidade || '';
  document.getElementById('i_prov').value = displayCurrency(item.provento);
  document.getElementById('i_rec').value = item.recorrente || 'N√£o';
  
  document.getElementById('invFormTitle').textContent = "Editando Investimento";
  document.getElementById('btnSaveInv').textContent = "Salvar Altera√ß√µes";
  document.getElementById('btnCancelInv').style.display = "inline-block";
  document.getElementById('formInvest').classList.add('editing');
  
  document.getElementById('formInvest').scrollIntoView({behavior: 'smooth', block: 'start'});
}

function resetInvForm() {
  document.getElementById('i_id').value = "";
  document.getElementById('i_ativo').value = "";
  document.getElementById('i_data').value = "";
  document.getElementById('i_valor').value = "";
  document.getElementById('i_qtd').value = "";
  document.getElementById('i_prov').value = "";
  document.getElementById('i_rec').selectedIndex = 0;
  document.getElementById('invFormTitle').textContent = "Novo Investimento";
  document.getElementById('btnSaveInv').textContent = "Adicionar Investimento";
  document.getElementById('btnCancelInv').style.display = "none";
  document.getElementById('formInvest').classList.remove('editing');
}

function deleteInvestimento(id) {
  if (confirm('Deseja realmente excluir este investimento?')) {
    investimentos = investimentos.filter(item => item.id !== id);
    localStorage.setItem('investimentos', JSON.stringify(investimentos));
    syncToSheetsAuto('investimentos', investimentos);
    renderInvestimentos();
    renderInvestimentoModalitySummary();
  }
}

function renderInvestimentoModalitySummary() {
  const summary = {};
  
  investimentos.forEach(item => {
    if (!summary[item.modalidade]) {
      summary[item.modalidade] = { total: 0, count: 0, proventos: 0, occurrences: 0 };
    }
    summary[item.modalidade].total += item.valor;
    
    const proventoRecorrente = calculateRecurringValue(item.provento, item.data, item.recorrente);
    const occurrences = calculateRecurrenceOccurrences(item.data, item.recorrente);
    
    summary[item.modalidade].proventos += proventoRecorrente;
    summary[item.modalidade].count++;
    summary[item.modalidade].occurrences += occurrences;
  });
  
  const container = document.getElementById('investimentoModalitySummary');
  container.innerHTML = '';
  
  Object.keys(summary).sort().forEach(modalidade => {
    const card = document.createElement('div');
    card.className = 'summary-card';
    
    card.innerHTML = `
      <h4>${modalidade}</h4>
      <p>R$ ${displayCurrency(summary[modalidade].total)}</p>
      <small style="opacity: 0.8; font-size: 12px;">${summary[modalidade].count} ativos</small><br>
      <small style="opacity: 0.8; font-size: 11px;">Proventos: R$ ${displayCurrency(summary[modalidade].proventos)}</small>
      <div class="recurrence-info">${summary[modalidade].occurrences} ocorr√™ncias calculadas</div>
    `;
    container.appendChild(card);
  });
}

// (Continue com as demais fun√ß√µes: Consigna√ß√£o, Anota√ß√µes, Vendas, Dashboard, etc.)
// Por brevidade, n√£o vou repetir todo o c√≥digo, mas voc√™ deve incluir todas as fun√ß√µes originais aqui
// ==================== CONSIGNA√á√ÉO ====================
function saveConsignacao() {
  const juros = parseFloat(document.getElementById('c_juros').value);
  
  if (juros > 100) {
    alert('Juros m√°ximo permitido por lei: 100% ao m√™s');
    return;
  }
  
  const id = document.getElementById('c_id').value;
  const valor = parseCurrency(document.getElementById('c_valor').value);
  const item = {
    id: id ? parseInt(id) : Date.now(),
    nome: document.getElementById('c_nome').value,
    valor: valor,
    juros: juros,
    parcelas: parseInt(document.getElementById('c_parcelas').value),
    vencimento: document.getElementById('c_vencimento').value,
    contato: document.getElementById('c_contato').value || '',
    pago: 0,
    total: valor * (1 + juros / 100)
  };
  
  if (!item.nome || item.valor === 0 || !item.vencimento) {
    alert('Preencha todos os campos obrigat√≥rios!');
    return;
  }
  
  if (id) {
    const index = consignacoes.findIndex(c => c.id === item.id);
    consignacoes[index] = item;
  } else {
    consignacoes.push(item);
  }
  
  localStorage.setItem('consignacoes', JSON.stringify(consignacoes));
  syncToSheetsAuto('consignacoes', consignacoes);
  resetConsForm();
  renderConsignacoes();
  renderConsignacaoSummary();
  renderConsignacaoChart();
}

function renderConsignacoes() {
  const table = document.getElementById('consignacaoTable');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '';
  
  const sortedData = [...consignacoes].sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento));
  
  sortedData.forEach(item => {
    const row = tbody.insertRow(-1);
    
    let status = 'Em Aberto';
    let statusClass = 'status-aberto';
    
    if (item.pago >= item.total) {
      status = 'Pago';
      statusClass = 'status-pago';
    } else if (new Date(item.vencimento) < new Date()) {
      status = 'Atrasado';
      statusClass = 'status-atrasado';
    }
    
    const restante = item.total - item.pago;
    const valorParcela = item.total / item.parcelas;
    
    row.innerHTML = `
      <td><strong>${item.nome}</strong>${item.contato ? '<br><small>' + item.contato + '</small>' : ''}</td>
      <td>R$ ${displayCurrency(item.valor)}</td>
      <td>${item.juros.toFixed(2)}%</td>
      <td>R$ ${displayCurrency(item.total)}</td>
      <td>R$ ${displayCurrency(item.pago)}<br><small>Restam: R$ ${displayCurrency(restante)}</small></td>
      <td>${new Date(item.vencimento).toLocaleDateString('pt-BR')}<br><small>${item.parcelas}x de R$ ${displayCurrency(valorParcela)}</small></td>
      <td><span class="${statusClass}">${status}</span></td>
      <td>
        <button class="btn-success" onclick="pagarParcela(${item.id})" ${item.pago >= item.total ? 'disabled' : ''}>Pagar Parcela</button><br>
        <button class="btn-edit" onclick="editConsignacao(${item.id})" style="margin-top:5px">Editar</button>
        <button class="btn-delete" onclick="deleteConsignacao(${item.id})" style="margin-top:5px">Excluir</button>
      </td>
    `;
  });
}

function pagarParcela(id) {
  const item = consignacoes.find(c => c.id === id);
  const valorParcela = item.total / item.parcelas;
  
  item.pago += valorParcela;
  if (item.pago > item.total) {
    item.pago = item.total;
  }
  
  localStorage.setItem('consignacoes', JSON.stringify(consignacoes));
  syncToSheetsAuto('consignacoes', consignacoes);
  renderConsignacoes();
  renderConsignacaoSummary();
  renderConsignacaoChart();
}

function editConsignacao(id) {
  const item = consignacoes.find(c => c.id === id);
  document.getElementById('c_id').value = item.id;
  document.getElementById('c_nome').value = item.nome;
  document.getElementById('c_valor').value = displayCurrency(item.valor);
  document.getElementById('c_juros').value = item.juros.toFixed(2);
  document.getElementById('c_parcelas').value = item.parcelas;
  document.getElementById('c_vencimento').value = item.vencimento;
  document.getElementById('c_contato').value = item.contato || '';
  
  document.getElementById('consigFormTitle').textContent = "Editando Empr√©stimo";
  document.getElementById('btnSaveCons').textContent = "Salvar Altera√ß√µes";
  document.getElementById('btnCancelCons').style.display = "inline-block";
  document.getElementById('formConsignacao').classList.add('editing');
  
  document.getElementById('formConsignacao').scrollIntoView({behavior: 'smooth', block: 'start'});
}

function resetConsForm() {
  document.getElementById('c_id').value = "";
  document.getElementById('c_nome').value = "";
  document.getElementById('c_valor').value = "";
  document.getElementById('c_juros').value = "";
  document.getElementById('c_parcelas').value = "";
  document.getElementById('c_vencimento').value = "";
  document.getElementById('c_contato').value = "";
  document.getElementById('consigFormTitle').textContent = "Novo Empr√©stimo";
  document.getElementById('btnSaveCons').textContent = "Adicionar Empr√©stimo";
  document.getElementById('btnCancelCons').style.display = "none";
  document.getElementById('formConsignacao').classList.remove('editing');
}

function deleteConsignacao(id) {
  if (confirm('Deseja realmente excluir este empr√©stimo?')) {
    consignacoes = consignacoes.filter(item => item.id !== id);
    localStorage.setItem('consignacoes', JSON.stringify(consignacoes));
    syncToSheetsAuto('consignacoes', consignacoes);
    renderConsignacoes();
    renderConsignacaoSummary();
    renderConsignacaoChart();
  }
}

function renderConsignacaoSummary() {
  let totalEmp = 0;
  let totalRec = 0;
  let totalAtraso = 0;
  
  consignacoes.forEach(item => {
    totalEmp += item.total;
    totalRec += item.pago;
    
    if (item.pago < item.total && new Date(item.vencimento) < new Date()) {
      totalAtraso++;
    }
  });
  
  document.getElementById('totalEmprestado').textContent = 'R$ ' + displayCurrency(totalEmp);
  document.getElementById('totalRecebido').textContent = 'R$ ' + displayCurrency(totalRec);
  document.getElementById('totalAberto').textContent = 'R$ ' + displayCurrency(totalEmp - totalRec);
  document.getElementById('totalAtrasado').textContent = totalAtraso;
}

function renderConsignacaoChart() {
  let totalEmp = 0;
  let totalRec = 0;
  
  consignacoes.forEach(item => {
    totalEmp += item.total;
    totalRec += item.pago;
  });
  
  const ctx = document.getElementById('consignacaoChart');
  
  if (consignacaoChart) {
    consignacaoChart.destroy();
  }
  
  consignacaoChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Emprestado (Total)', 'Recebido (Pago)'],
      datasets: [{
        label: 'Valores em R$',
        data: [totalEmp, totalRec],
        backgroundColor: [
          'rgba(102, 126, 234, 0.8)',
          'rgba(40, 167, 69, 0.8)'
        ],
        borderColor: [
          'rgba(102, 126, 234, 1)',
          'rgba(40, 167, 69, 1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'R$ ' + displayCurrency(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'R$ ' + displayCurrency(value);
            }
          }
        }
      }
    }
  });
}

function exportConsignacaoCSV() {
  if (consignacoes.length === 0) {
    alert('N√£o h√° dados para exportar!');
    return;
  }
  
  let csv = 'Nome,Valor Inicial,Juros (%),Total com Juros,Pago,Restante,Vencimento,Status\n';
  
  consignacoes.forEach(item => {
    let status = 'Em Aberto';
    if (item.pago >= item.total) {
      status = 'Pago';
    } else if (new Date(item.vencimento) < new Date()) {
      status = 'Atrasado';
    }
    
    const restante = item.total - item.pago;
    
    csv += `${item.nome},${item.valor.toFixed(2)},${item.juros.toFixed(2)},${item.total.toFixed(2)},${item.pago.toFixed(2)},${restante.toFixed(2)},${item.vencimento},${status}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', 'consignacoes.csv');
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  alert('Arquivo consignacoes.csv exportado com sucesso!');
}

function exportConsignacaoPDF() {
  if (consignacoes.length === 0) {
    alert('N√£o h√° dados para exportar!');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  
  pdf.setFontSize(16);
  pdf.text('Relat√≥rio de Empr√©stimos', 10, 10);
  
  pdf.setFontSize(10);
  let y = 25;
  
  consignacoes.forEach((item, index) => {
    if (y > 270) {
      pdf.addPage();
      y = 10;
    }
    
    let status = 'Em Aberto';
    if (item.pago >= item.total) {
      status = 'Pago';
    } else if (new Date(item.vencimento) < new Date()) {
      status = 'Atrasado';
    }
    
    const restante = item.total - item.pago;
    
    pdf.text(`${index + 1}. ${item.nome}`, 10, y);
    y += 6;
    pdf.text(`   Valor: R$ ${displayCurrency(item.valor)} | Juros: ${item.juros.toFixed(2)}% | Total: R$ ${displayCurrency(item.total)}`, 10, y);
    y += 6;
    pdf.text(`   Pago: R$ ${displayCurrency(item.pago)} | Restante: R$ ${displayCurrency(restante)} | Status: ${status}`, 10, y);
    y += 6;
    pdf.text(`   Vencimento: ${new Date(item.vencimento).toLocaleDateString('pt-BR')} | Parcelas: ${item.parcelas}`, 10, y);
    y += 10;
  });
  
  pdf.save('consignacoes.pdf');
  alert('Arquivo consignacoes.pdf exportado com sucesso!');
}

// ==================== ANOTA√á√ïES ====================
function saveAnotacao() {
  const id = document.getElementById('a_id').value;
  const item = {
    id: id ? parseInt(id) : Date.now(),
    titulo: document.getElementById('a_titulo').value,
    notas: document.getElementById('a_notas').value,
    prioridade: document.getElementById('a_prioridade').value
  };
  
  if (!item.titulo) {
    alert('Preencha o t√≠tulo!');
    return;
  }
  
  if (id) {
    const index = anotacoes.findIndex(a => a.id === item.id);
    anotacoes[index] = item;
  } else {
    anotacoes.push(item);
  }
  
  localStorage.setItem('anotacoes', JSON.stringify(anotacoes));
  syncToSheetsAuto('anotacoes', anotacoes);
  resetAnotForm();
  renderAnotacoes();
  renderAnotacoesPrioritySummary();
}

function renderAnotacoes(filtered = null) {
  const data = filtered || anotacoes;
  const table = document.getElementById('anotacoesTable');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '';
  
  const sortedData = [...data].reverse();
  
  sortedData.forEach(item => {
    const row = tbody.insertRow(-1);
    const prioColor = item.prioridade === 'Alta' ? '#e74c3c' : item.prioridade === 'M√©dia' ? '#f39c12' : '#95a5a6';
    
    row.innerHTML = `
      <td><strong>${item.titulo}</strong></td>
      <td><span style="padding: 4px 8px; border-radius: 4px; background: ${prioColor}; color: white;">${item.prioridade}</span></td>
      <td>${item.notas || '-'}</td>
      <td>
        <button class="btn-edit" onclick="editAnotacao(${item.id})">Editar</button>
        <button class="btn-delete" onclick="deleteAnotacao(${item.id})">Excluir</button>
      </td>
    `;
  });
}

function editAnotacao(id) {
  const item = anotacoes.find(a => a.id === id);
  document.getElementById('a_id').value = item.id;
  document.getElementById('a_titulo').value = item.titulo;
  document.getElementById('a_notas').value = item.notas || '';
  document.getElementById('a_prioridade').value = item.prioridade;
  
  document.getElementById('anotFormTitle').textContent = "Editando Anota√ß√£o";
  document.getElementById('btnSaveAnot').textContent = "Salvar Altera√ß√µes";
  document.getElementById('btnCancelAnot').style.display = "inline-block";
  document.getElementById('formAnot').classList.add('editing');
  
  document.getElementById('formAnot').scrollIntoView({behavior: 'smooth', block: 'start'});
}

function resetAnotForm() {
  document.getElementById('a_id').value = "";
  document.getElementById('a_titulo').value = "";
  document.getElementById('a_notas').value = "";
  document.getElementById('a_prioridade').selectedIndex = 0;
  document.getElementById('anotFormTitle').textContent = "Nova Anota√ß√£o";
  document.getElementById('btnSaveAnot').textContent = "Adicionar Anota√ß√£o";
  document.getElementById('btnCancelAnot').style.display = "none";
  document.getElementById('formAnot').classList.remove('editing');
}

function deleteAnotacao(id) {
  if (confirm('Deseja realmente excluir esta anota√ß√£o?')) {
    anotacoes = anotacoes.filter(item => item.id !== id);
    localStorage.setItem('anotacoes', JSON.stringify(anotacoes));
    syncToSheetsAuto('anotacoes', anotacoes);
    renderAnotacoes();
    renderAnotacoesPrioritySummary();
  }
}

function renderAnotacoesPrioritySummary() {
  const summary = { 'Alta': 0, 'M√©dia': 0, 'Baixa': 0 };
  
  anotacoes.forEach(item => {
    summary[item.prioridade]++;
  });
  
  const container = document.getElementById('anotacoesPrioritySummary');
  container.innerHTML = '';
  
  Object.keys(summary).forEach(prioridade => {
    const card = document.createElement('div');
    card.className = 'summary-card';
    
    if (prioridade === 'Alta') {
      card.classList.add('danger');
    } else if (prioridade === 'M√©dia') {
      card.classList.add('warning');
    }
    
    card.innerHTML = `
      <h4>Prioridade ${prioridade}</h4>
      <p>${summary[prioridade]}</p>
      <small style="opacity: 0.8; font-size: 12px;">anota√ß√µes</small>
    `;
    container.appendChild(card);
  });
}

// ==================== VENDAS ====================
function saveVenda() {
  const item = {
    id: Date.now(),
    cliente: document.getElementById('v_cliente').value,
    tipo: document.getElementById('v_tipo').value,
    custo: parseCurrency(document.getElementById('v_custo').value),
    valor: parseCurrency(document.getElementById('v_valor').value),
    descricao: document.getElementById('v_descricao').value,
    data: new Date().toISOString(),
    oculto: false
  };

  if (!item.cliente || item.valor === 0) {
    alert('Preencha os dados b√°sicos da venda (Cliente e Valor).');
    return;
  }

  vendas.push(item);
  localStorage.setItem('vendas', JSON.stringify(vendas));
  syncToSheetsAuto('vendas', vendas);
  renderVendas();
  limparFormVendas();
}

function renderVendas() {
  const tbody = document.querySelector('#vendasTable tbody');
  tbody.innerHTML = '';
  
  let bruto = 0;
  let lucroTotal = 0;

  vendas.forEach(item => {
    if (item.oculto) return;

    const lucro = item.valor - item.custo;
    bruto += item.valor;
    lucroTotal += lucro;

    const row = tbody.insertRow();
    row.innerHTML = `
      <td>${new Date(item.data).toLocaleDateString('pt-BR')}</td>
      <td>${item.cliente}</td>
      <td>R$ ${displayCurrency(item.valor)}</td>
      <td style="color: ${lucro >= 0 ? 'green' : 'red'}">R$ ${displayCurrency(lucro)}</td>
      <td>
        <button class="btn-secondary" onclick="toggleOcultarVenda(${item.id})">Ocultar</button>
        <button class="btn-delete" onclick="deleteVenda(${item.id})">Excluir</button>
      </td>
    `;
  });

  document.getElementById('totalVendasBruto').textContent = 'R$ ' + displayCurrency(bruto);
  document.getElementById('totalLucroVendas').textContent = 'R$ ' + displayCurrency(lucroTotal);
}

function toggleOcultarVenda(id) {
  const index = vendas.findIndex(v => v.id === id);
  vendas[index].oculto = true;
  localStorage.setItem('vendas', JSON.stringify(vendas));
  syncToSheetsAuto('vendas', vendas);
  renderVendas();
}

function deleteVenda(id) {
  if(confirm("Excluir permanentemente esta venda?")) {
    vendas = vendas.filter(v => v.id !== id);
    localStorage.setItem('vendas', JSON.stringify(vendas));
    syncToSheetsAuto('vendas', vendas);
    renderVendas();
  }
}

function limparFormVendas() {
  document.getElementById('v_cliente').value = '';
  document.getElementById('v_tipo').selectedIndex = 0;
  document.getElementById('v_custo').value = '';
  document.getElementById('v_valor').value = '';
  document.getElementById('v_descricao').value = '';
}

// ==================== DASHBOARD MELHORADO ====================
// ==================== CONTROLE DE PER√çODO DO DASHBOARD ====================
let dashboardPeriodView = 'all'; // 'all', 'current', ou 'custom'
let dashboardCustomMonth = null;

function setDashboardPeriod(view) {
  dashboardPeriodView = view;
  
  // Atualizar bot√µes ativos
  document.querySelectorAll('.period-toggle-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  if (view === 'all') {
    document.getElementById('dashPeriodAll').classList.add('active');
    document.getElementById('dashCustomMonthSelector').style.display = 'none';
    document.getElementById('dashCurrentPeriodDisplay').textContent = 'Todos os Meses';
  } else if (view === 'current') {
    document.getElementById('dashPeriodCurrent').classList.add('active');
    document.getElementById('dashCustomMonthSelector').style.display = 'none';
    const hoje = new Date();
    const mesNome = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'][hoje.getMonth()];
    document.getElementById('dashCurrentPeriodDisplay').textContent = `${mesNome}/${hoje.getFullYear()}`;
  } else if (view === 'custom') {
    document.getElementById('dashPeriodCustom').classList.add('active');
    document.getElementById('dashCustomMonthSelector').style.display = 'block';
    const hoje = new Date();
    const mesAtual = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
    document.getElementById('dashCustomMonth').value = mesAtual;
    return; // N√£o renderizar ainda, esperar o usu√°rio selecionar
  }
  
  renderDashboard();
}

function applyDashboardCustomMonth() {
  const mesAno = document.getElementById('dashCustomMonth').value;
  
  if (!mesAno) {
    alert('Selecione um m√™s!');
    return;
  }
  
  dashboardCustomMonth = mesAno;
  const [ano, mes] = mesAno.split('-');
  const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  document.getElementById('dashCurrentPeriodDisplay').textContent = `${meses[parseInt(mes) - 1]}/${ano}`;
  
  renderDashboard();
}

// ==================== DASHBOARD MELHORADO COM FILTRO DE PER√çODO ====================
function renderDashboard() {
  let dataToAnalyze = financeiro;
  
  // APLICAR FILTRO DE PER√çODO
  if (dashboardPeriodView === 'current') {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    dataToAnalyze = financeiro.filter(item => {
      const itemDate = new Date(item.data);
      return itemDate.getMonth() === mesAtual && itemDate.getFullYear() === anoAtual;
    });
  } else if (dashboardPeriodView === 'custom' && dashboardCustomMonth) {
    const [ano, mes] = dashboardCustomMonth.split('-');
    
    dataToAnalyze = financeiro.filter(item => {
      const itemDate = new Date(item.data);
      return itemDate.getFullYear() === parseInt(ano) && itemDate.getMonth() + 1 === parseInt(mes);
    });
  }
  
  // Calcular valores DETALHADOS por tipo
  let receitasRecebidas = 0;
  let receitasAReceber = 0;
  let despesasPagas = 0;
  let despesasAPagar = 0;
  
  let totalRec = 0;
  let totalDesp = 0;
  
  dataToAnalyze.forEach(item => {
    const valorRecorrente = calculateRecurringValue(item.valor, item.data, item.recorrente);
    
    // RECEITAS
    if (item.tipo === 'Recebido') {
      receitasRecebidas += valorRecorrente;
      totalRec += valorRecorrente;
    } else if (item.tipo === 'A Receber') {
      receitasAReceber += valorRecorrente;
      totalRec += valorRecorrente;
    }
    
    // DESPESAS
    else if (item.tipo === 'Pago') {
      despesasPagas += valorRecorrente;
      totalDesp += valorRecorrente;
    } else if (item.tipo === 'Pagar') {
      despesasAPagar += valorRecorrente;
      totalDesp += valorRecorrente;
    }
  });
  
  // SALDO L√çQUIDO = Total Receitas - Total Despesas
  const saldoLiquido = totalRec - totalDesp;
  const saldo = totalRec - totalDesp;
  
  // Investimentos (sempre todos)
  let totalInvest = 0;
  let totalProv = 0;
  
  investimentos.forEach(item => {
    totalInvest += item.valor;
    const proventoRecorrente = calculateRecurringValue(item.provento, item.data, item.recorrente);
    totalProv += proventoRecorrente;
  });
  
  // Empr√©stimos (sempre todos)
  let totalEmprestimos = 0;
  consignacoes.forEach(item => {
    totalEmprestimos += (item.total - item.pago);
  });
  
  const patrimonio = saldo + totalInvest + totalEmprestimos;
  
  // ATUALIZAR NOVOS CARDS
  document.getElementById('dashReceitasRecebidas').textContent = 'R$ ' + displayCurrency(receitasRecebidas);
  document.getElementById('dashReceitasAReceber').textContent = 'R$ ' + displayCurrency(receitasAReceber);
  document.getElementById('dashDespesasPagas').textContent = 'R$ ' + displayCurrency(despesasPagas);
  document.getElementById('dashDespesasAPagar').textContent = 'R$ ' + displayCurrency(despesasAPagar);
  
  // Colorir o saldo l√≠quido
  const saldoLiquidoEl = document.getElementById('dashSaldoLiquido');
  saldoLiquidoEl.textContent = 'R$ ' + displayCurrency(Math.abs(saldoLiquido));
  if (saldoLiquido >= 0) {
    saldoLiquidoEl.style.color = '#28a745';
  } else {
    saldoLiquidoEl.style.color = '#e74c3c';
    saldoLiquidoEl.textContent = '- R$ ' + displayCurrency(Math.abs(saldoLiquido));
  }
  
  // ATUALIZAR CARDS ORIGINAIS
  document.getElementById('dashSaldo').textContent = 'R$ ' + displayCurrency(saldo);
  document.getElementById('dashInvest').textContent = 'R$ ' + displayCurrency(totalInvest);
  document.getElementById('dashProv').textContent = 'R$ ' + displayCurrency(totalProv);
  document.getElementById('dashEmprestimos').textContent = 'R$ ' + displayCurrency(totalEmprestimos);
  document.getElementById('dashPatrimonio').textContent = 'R$ ' + displayCurrency(patrimonio);
  
  document.getElementById('totalReceitas').textContent = 'R$ ' + displayCurrency(totalRec);
  document.getElementById('totalDespesas').textContent = 'R$ ' + displayCurrency(totalDesp);
  document.getElementById('numTransacoes').textContent = dataToAnalyze.length;
  document.getElementById('numInvestimentos').textContent = investimentos.length;
  document.getElementById('numEmprestimos').textContent = consignacoes.length;
  document.getElementById('numAnotacoes').textContent = anotacoes.length;
}
// ==================== MODO ESCURO/CLARO ====================
function toggleTheme() {
  const body = document.body;
  const button = document.getElementById('themeToggle');
  
  body.classList.toggle('dark-mode');
  
  // Atualizar √≠cone do bot√£o
  if (body.classList.contains('dark-mode')) {
    button.textContent = '‚òÄÔ∏è';
    button.title = 'Modo Claro';
    localStorage.setItem('darkMode', 'enabled');
  } else {
    button.textContent = 'üåô';
    button.title = 'Modo Escuro';
    localStorage.setItem('darkMode', 'disabled');
  }
}

// Carregar prefer√™ncia de tema ao iniciar
function loadThemePreference() {
  const darkMode = localStorage.getItem('darkMode');
  const button = document.getElementById('themeToggle');
  
  if (darkMode === 'enabled') {
    document.body.classList.add('dark-mode');
    if (button) {
      button.textContent = '‚òÄÔ∏è';
      button.title = 'Modo Claro';
    }
  }
}

// Chamar ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', loadThemePreference);
// ==================== ORDENA√á√ÉO DE TABELAS ====================
function sortTable(tableId, columnIndex) {
  const table = document.getElementById(tableId);
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const header = table.querySelectorAll('th')[columnIndex];
  
  const isAsc = header.classList.contains('sorted-asc');
  
  table.querySelectorAll('th').forEach(th => {
    th.classList.remove('sorted-asc', 'sorted-desc');
  });
  
  if (isAsc) {
    header.classList.add('sorted-desc');
  } else {
    header.classList.add('sorted-asc');
  }
  
  rows.sort((a, b) => {
    const aText = a.cells[columnIndex].textContent.trim();
    const bText = b.cells[columnIndex].textContent.trim();
    
    const aNum = parseFloat(aText.replace(/[^\d,-]/g, '').replace(',', '.'));
    const bNum = parseFloat(bText.replace(/[^\d,-]/g, '').replace(',', '.'));
    
    if (!isNaN(aNum) && !isNaN(bNum)) {
      return isAsc ? bNum - aNum : aNum - bNum;
    }
    
    return isAsc ? bText.localeCompare(aText) : aText.localeCompare(bText);
  });
  
  rows.forEach(row => tbody.appendChild(row));
}

// ==================== EXPORTAR CSV ====================
function exportToCSV(tipo) {
  let data;
  let filename;
  
  if (tipo === 'financeiro') {
    data = financeiro;
    filename = 'financeiro.csv';
  } else if (tipo === 'investimento') {
    data = investimentos;
    filename = 'investimentos.csv';
  } else if (tipo === 'anotacoes') {
    data = anotacoes;
    filename = 'anotacoes.csv';
  } else if (tipo === 'vendas') {
    data = vendas;
    filename = 'vendas.csv';
  }
  
  if (!data || data.length === 0) {
    alert('N√£o h√° dados para exportar!');
    return;
  }
  
  const headers = Object.keys(data[0]);
  const csv = [
    headers.join(','),
    ...data.map(row => headers.map(key => {
      const value = row[key];
      return typeof value === 'string' && (value.includes(',') || value.includes('\n')) 
        ? `"${value}"` 
        : value;
    }).join(','))
  ].join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  alert(`Arquivo ${filename} exportado com sucesso!`);
}

// Adicione aqui o resto das fun√ß√µes do sistema original...
// (renderDashboard, renderConsignacoes, renderAnotacoes, renderVendas, etc.)
// ==================== FILTROS AVAN√áADOS - FINANCEIRO ====================
function filtrarHoje(tipo) {
  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);
  const amanha = new Date(hoje);
  amanha.setDate(amanha.getDate() + 1);
  
  const filtered = financeiro.filter(item => {
    const itemDate = new Date(item.data);
    return itemDate >= hoje && itemDate < amanha;
  });
  
  renderFinanceiro(filtered);
  alert(`Mostrando ${filtered.length} transa√ß√£o(√µes) de hoje`);
}

function filtrarSemana(tipo) {
  const hoje = new Date();
  const primeiroDia = new Date(hoje);
  primeiroDia.setDate(hoje.getDate() - hoje.getDay());
  primeiroDia.setHours(0, 0, 0, 0);
  
  const filtered = financeiro.filter(item => {
    const itemDate = new Date(item.data);
    return itemDate >= primeiroDia;
  });
  
  renderFinanceiro(filtered);
  alert(`Mostrando ${filtered.length} transa√ß√£o(√µes) desta semana`);
}

function filtrarMes(tipo) {
  const hoje = new Date();
  const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  
  const filtered = financeiro.filter(item => {
    const itemDate = new Date(item.data);
    return itemDate >= primeiroDia;
  });
  
  renderFinanceiro(filtered);
  document.getElementById('filtroAtivo').textContent = 'M√™s atual';
  alert(`Mostrando ${filtered.length} transa√ß√£o(√µes) deste m√™s`);
}

function mostrarTodos(tipo) {
  renderFinanceiro();
  document.getElementById('searchFinanceiro').value = '';
  alert('Mostrando todas as transa√ß√µes');
}



function buscarFinanceiro() {
  const termo = document.getElementById('searchFinanceiro').value.toLowerCase();
  
  if (!termo) {
    renderFinanceiro();
    return;
  }
  
  const filtered = financeiro.filter(item => {
    return item.descricao.toLowerCase().includes(termo) ||
           item.categoria.toLowerCase().includes(termo) ||
           item.tipo.toLowerCase().includes(termo) ||
           item.valor.toString().includes(termo);
  });
  
  renderFinanceiro(filtered);
}

// ==================== FILTROS - INVESTIMENTOS ====================
let investimentosFiltrados = null;

function buscarInvestimentos() {
  const termo = document.getElementById('searchInvestimentos').value.toLowerCase();
  
  if (!termo) {
    renderInvestimentos(investimentosFiltrados);
    return;
  }
  
  const base = investimentosFiltrados || investimentos;
  const filtered = base.filter(item => {
    return item.ativo.toLowerCase().includes(termo) ||
           item.modalidade.toLowerCase().includes(termo);
  });
  
  renderInvestimentos(filtered);
}

function filtrarInvestimentos() {
  const modalidade = document.getElementById('filterInvModalidade').value;
  
  if (!modalidade) {
    investimentosFiltrados = null;
    renderInvestimentos();
    return;
  }
  
  investimentosFiltrados = investimentos.filter(item => item.modalidade === modalidade);
  renderInvestimentos(investimentosFiltrados);
}

function limparFiltrosInvestimentos() {
  document.getElementById('searchInvestimentos').value = '';
  document.getElementById('filterInvModalidade').value = '';
  investimentosFiltrados = null;
  renderInvestimentos();
}

// ==================== FILTROS - CONSIGNA√á√ÉO ====================
let consignacoesFiltradas = null;

function buscarConsignacao() {
  const termo = document.getElementById('searchConsignacao').value.toLowerCase();
  
  if (!termo) {
    renderConsignacoes();
    return;
  }
  
  const filtered = consignacoes.filter(item => {
    return item.nome.toLowerCase().includes(termo) ||
           (item.contato && item.contato.toLowerCase().includes(termo));
  });
  
  consignacoesFiltradas = filtered;
  renderConsignacoes();
}

function filtrarConsignacao() {
  const status = document.getElementById('filterConsStatus').value;
  const dataInicio = document.getElementById('filterConsDataInicio').value;
  const dataFim = document.getElementById('filterConsDataFim').value;
  
  let filtered = [...consignacoes];
  
  // Filtrar por status
  if (status) {
    filtered = filtered.filter(item => {
      if (status === 'pago') {
        return item.pago >= item.total;
      } else if (status === 'atrasado') {
        return item.pago < item.total && new Date(item.vencimento) < new Date();
      } else if (status === 'aberto') {
        return item.pago < item.total && new Date(item.vencimento) >= new Date();
      }
      return true;
    });
  }
  
  // Filtrar por data
  if (dataInicio) {
    filtered = filtered.filter(item => new Date(item.vencimento) >= new Date(dataInicio));
  }
  if (dataFim) {
    filtered = filtered.filter(item => new Date(item.vencimento) <= new Date(dataFim + 'T23:59:59'));
  }
  
  consignacoesFiltradas = filtered;
  
  // Renderizar apenas a tabela
  const table = document.getElementById('consignacaoTable');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = '';
  
  const sortedData = [...filtered].sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento));
  
  sortedData.forEach(item => {
    const row = tbody.insertRow(-1);
    
    let status = 'Em Aberto';
    let statusClass = 'status-aberto';
    
    if (item.pago >= item.total) {
      status = 'Pago';
      statusClass = 'status-pago';
    } else if (new Date(item.vencimento) < new Date()) {
      status = 'Atrasado';
      statusClass = 'status-atrasado';
    }
    
    const restante = item.total - item.pago;
    const valorParcela = item.total / item.parcelas;
    
    row.innerHTML = `
      <td><strong>${item.nome}</strong>${item.contato ? '<br><small>' + item.contato + '</small>' : ''}</td>
      <td>R$ ${displayCurrency(item.valor)}</td>
      <td>${item.juros.toFixed(2)}%</td>
      <td>R$ ${displayCurrency(item.total)}</td>
      <td>R$ ${displayCurrency(item.pago)}<br><small>Restam: R$ ${displayCurrency(restante)}</small></td>
      <td>${new Date(item.vencimento).toLocaleDateString('pt-BR')}<br><small>${item.parcelas}x de R$ ${displayCurrency(valorParcela)}</small></td>
      <td><span class="${statusClass}">${status}</span></td>
      <td>
        <button class="btn-success" onclick="pagarParcela(${item.id})" ${item.pago >= item.total ? 'disabled' : ''}>Pagar Parcela</button><br>
        <button class="btn-edit" onclick="editConsignacao(${item.id})" style="margin-top:5px">Editar</button>
        <button class="btn-delete" onclick="deleteConsignacao(${item.id})" style="margin-top:5px">Excluir</button>
      </td>
    `;
  });
  
  alert(`Mostrando ${filtered.length} empr√©stimo(s)`);
}

function limparFiltrosConsignacao() {
  document.getElementById('searchConsignacao').value = '';
  document.getElementById('filterConsStatus').value = '';
  document.getElementById('filterConsDataInicio').value = '';
  document.getElementById('filterConsDataFim').value = '';
  consignacoesFiltradas = null;
  renderConsignacoes();
}

// ==================== FILTROS - ANOTA√á√ïES ====================
let anotacoesFiltradas = null;

function buscarAnotacoes() {
  const termo = document.getElementById('searchAnotacoes').value.toLowerCase();
  
  if (!termo) {
    renderAnotacoes(anotacoesFiltradas);
    return;
  }
  
  const base = anotacoesFiltradas || anotacoes;
  const filtered = base.filter(item => {
    return item.titulo.toLowerCase().includes(termo) ||
           (item.notas && item.notas.toLowerCase().includes(termo));
  });
  
  renderAnotacoes(filtered);
}

function filtrarAnotacoes() {
  const prioridade = document.getElementById('filterAnotPrioridade').value;
  
  if (!prioridade) {
    anotacoesFiltradas = null;
    renderAnotacoes();
    return;
  }
  
  anotacoesFiltradas = anotacoes.filter(item => item.prioridade === prioridade);
  renderAnotacoes(anotacoesFiltradas);
}

function limparFiltrosAnotacoes() {
  document.getElementById('searchAnotacoes').value = '';
  document.getElementById('filterAnotPrioridade').value = '';
  anotacoesFiltradas = null;
  renderAnotacoes();
}

// ==================== FILTROS - VENDAS ====================
let vendasFiltradas = null;

function buscarVendas() {
  const termo = document.getElementById('searchVendas').value.toLowerCase();
  
  if (!termo) {
    renderVendas();
    return;
  }
  
  const filtered = vendas.filter(item => {
    return !item.oculto && (
      item.cliente.toLowerCase().includes(termo) ||
      (item.descricao && item.descricao.toLowerCase().includes(termo))
    );
  });
  
  // Renderizar filtrado
  const tbody = document.querySelector('#vendasTable tbody');
  tbody.innerHTML = '';
  
  let bruto = 0;
  let lucroTotal = 0;

  filtered.forEach(item => {
    const lucro = item.valor - item.custo;
    bruto += item.valor;
    lucroTotal += lucro;

    const row = tbody.insertRow();
    row.innerHTML = `
      <td>${new Date(item.data).toLocaleDateString('pt-BR')}</td>
      <td>${item.cliente}</td>
      <td>R$ ${displayCurrency(item.valor)}</td>
      <td style="color: ${lucro >= 0 ? 'green' : 'red'}">R$ ${displayCurrency(lucro)}</td>
      <td>
        <button class="btn-secondary" onclick="toggleOcultarVenda(${item.id})">Ocultar</button>
        <button class="btn-delete" onclick="deleteVenda(${item.id})">Excluir</button>
      </td>
    `;
  });

  document.getElementById('totalVendasBruto').textContent = 'R$ ' + displayCurrency(bruto);
  document.getElementById('totalLucroVendas').textContent = 'R$ ' + displayCurrency(lucroTotal);
}

function filtrarVendas() {
  const tipo = document.getElementById('filterVendasTipo').value;
  const dataInicio = document.getElementById('filterVendasDataInicio').value;
  const dataFim = document.getElementById('filterVendasDataFim').value;
  
  let filtered = vendas.filter(item => !item.oculto);
  
  if (tipo) {
    filtered = filtered.filter(item => item.tipo === tipo);
  }
  
  if (dataInicio) {
    filtered = filtered.filter(item => new Date(item.data) >= new Date(dataInicio));
  }
  
  if (dataFim) {
    filtered = filtered.filter(item => new Date(item.data) <= new Date(dataFim + 'T23:59:59'));
  }
  
  // Renderizar filtrado
  const tbody = document.querySelector('#vendasTable tbody');
  tbody.innerHTML = '';
  
  let bruto = 0;
  let lucroTotal = 0;

  filtered.forEach(item => {
    const lucro = item.valor - item.custo;
    bruto += item.valor;
    lucroTotal += lucro;

    const row = tbody.insertRow();
    row.innerHTML = `
      <td>${new Date(item.data).toLocaleDateString('pt-BR')}</td>
      <td>${item.cliente}</td>
      <td>R$ ${displayCurrency(item.valor)}</td>
      <td style="color: ${lucro >= 0 ? 'green' : 'red'}">R$ ${displayCurrency(lucro)}</td>
      <td>
        <button class="btn-secondary" onclick="toggleOcultarVenda(${item.id})">Ocultar</button>
        <button class="btn-delete" onclick="deleteVenda(${item.id})">Excluir</button>
      </td>
    `;
  });

  document.getElementById('totalVendasBruto').textContent = 'R$ ' + displayCurrency(bruto);
  document.getElementById('totalLucroVendas').textContent = 'R$ ' + displayCurrency(lucroTotal);
  
  alert(`Mostrando ${filtered.length} venda(s)`);
}

function limparFiltrosVendas() {
  document.getElementById('searchVendas').value = '';
  document.getElementById('filterVendasTipo').value = '';
  document.getElementById('filterVendasDataInicio').value = '';
  document.getElementById('filterVendasDataFim').value = '';
  renderVendas();
}
// ==================== COMPARA√á√ÉO DE PER√çODOS ====================
function compararPeriodos() {
  const periodo1 = document.getElementById('comp_periodo1').value;
  const periodo2 = document.getElementById('comp_periodo2').value;
  
  if (!periodo1 || !periodo2) {
    alert('Selecione ambos os per√≠odos!');
    return;
  }
  
  // Calcular valores per√≠odo 1
  const [ano1, mes1] = periodo1.split('-');
  const dados1 = calcularPeriodo(parseInt(ano1), parseInt(mes1));
  
  // Calcular valores per√≠odo 2
  const [ano2, mes2] = periodo2.split('-');
  const dados2 = calcularPeriodo(parseInt(ano2), parseInt(mes2));
  
  // Exibir resultados
  document.getElementById('comp_rec_p1').textContent = `P1: R$ ${displayCurrency(dados1.receitas)}`;
  document.getElementById('comp_rec_p2').textContent = `P2: R$ ${displayCurrency(dados2.receitas)}`;
  
  const diffRec = dados2.receitas - dados1.receitas;
  const diffRecEl = document.getElementById('comp_rec_diff');
  diffRecEl.textContent = `${diffRec >= 0 ? '+' : ''}R$ ${displayCurrency(Math.abs(diffRec))}`;
  diffRecEl.className = diffRec >= 0 ? 'comparison-positive' : 'comparison-negative';
  
  document.getElementById('comp_desp_p1').textContent = `P1: R$ ${displayCurrency(dados1.despesas)}`;
  document.getElementById('comp_desp_p2').textContent = `P2: R$ ${displayCurrency(dados2.despesas)}`;
  
  const diffDesp = dados2.despesas - dados1.despesas;
  const diffDespEl = document.getElementById('comp_desp_diff');
  diffDespEl.textContent = `${diffDesp >= 0 ? '+' : ''}R$ ${displayCurrency(Math.abs(diffDesp))}`;
  diffDespEl.className = diffDesp >= 0 ? 'comparison-negative' : 'comparison-positive';
  
  const saldo1 = dados1.receitas - dados1.despesas;
  const saldo2 = dados2.receitas - dados2.despesas;
  
  document.getElementById('comp_saldo_p1').textContent = `P1: R$ ${displayCurrency(saldo1)}`;
  document.getElementById('comp_saldo_p2').textContent = `P2: R$ ${displayCurrency(saldo2)}`;
  
  const diffSaldo = saldo2 - saldo1;
  const diffSaldoEl = document.getElementById('comp_saldo_diff');
  diffSaldoEl.textContent = `${diffSaldo >= 0 ? '+' : ''}R$ ${displayCurrency(Math.abs(diffSaldo))}`;
  diffSaldoEl.className = diffSaldo >= 0 ? 'comparison-positive' : 'comparison-negative';
  
  // Mostrar resultados e gr√°fico
  document.getElementById('comparisonResults').style.display = 'block';
  renderComparisonChart(dados1, dados2, periodo1, periodo2);
}

function calcularPeriodo(ano, mes) {
  let receitas = 0;
  let despesas = 0;
  
  financeiro.forEach(item => {
    const itemDate = new Date(item.data);
    if (itemDate.getFullYear() === ano && itemDate.getMonth() + 1 === mes) {
      if (item.tipo === 'Recebido' || item.tipo === 'A Receber') {
        receitas += item.valor;
      } else {
        despesas += item.valor;
      }
    }
  });
  
  return { receitas, despesas };
}

function renderComparisonChart(dados1, dados2, periodo1, periodo2) {
  const ctx = document.getElementById('comparisonChart');
  
  if (comparisonChart) {
    comparisonChart.destroy();
  }
  
  comparisonChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Receitas', 'Despesas', 'Saldo'],
      datasets: [
        {
          label: periodo1,
          data: [dados1.receitas, dados1.despesas, dados1.receitas - dados1.despesas],
          backgroundColor: 'rgba(102, 126, 234, 0.8)',
        },
        {
          label: periodo2,
          data: [dados2.receitas, dados2.despesas, dados2.receitas - dados2.despesas],
          backgroundColor: 'rgba(118, 75, 162, 0.8)',
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Compara√ß√£o de Per√≠odos'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': R$ ' + displayCurrency(context.parsed.y);
            }
          }
        }
      }
    }
  });
}

// ==================== GERENCIAR CATEGORIAS ====================
function saveCategoria() {
  const id = document.getElementById('cat_id').value;
  const nome = document.getElementById('cat_nome').value.trim();
  
  if (!nome) {
    alert('Preencha o nome da categoria!');
    return;
  }
  
  // Verificar se j√° existe
  const jaExiste = categorias.some(c => c.nome.toLowerCase() === nome.toLowerCase());
  const existePadrao = categoriasDefault.some(c => c.toLowerCase() === nome.toLowerCase());
  
  if (jaExiste || existePadrao) {
    alert('Esta categoria j√° existe!');
    return;
  }
  
  const item = {
    id: id ? parseInt(id) : Date.now(),
    nome: nome
  };
  
  if (id) {
    const index = categorias.findIndex(c => c.id === item.id);
    categorias[index] = item;
  } else {
    categorias.push(item);
  }
  
  localStorage.setItem('categorias', JSON.stringify(categorias));
  resetCatForm();
  renderCategorias();
  updateCategorySelects();
}

function renderCategorias() {
  // Categorias padr√£o
  const defaultList = document.getElementById('defaultCategoriesList');
  defaultList.innerHTML = '';
  
  categoriasDefault.forEach(cat => {
    const item = document.createElement('div');
    item.className = 'category-item';
    item.innerHTML = `
      <span class="category-name">üè∑Ô∏è ${cat}</span>
      <span style="color: #999; font-size: 12px;">Categoria padr√£o do sistema</span>
    `;
    defaultList.appendChild(item);
  });
  
  // Categorias personalizadas
  const customList = document.getElementById('customCategoriesList');
  customList.innerHTML = '';
  
  if (categorias.length === 0) {
    customList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Nenhuma categoria personalizada ainda</p>';
    return;
  }
  
  categorias.forEach(cat => {
    const item = document.createElement('div');
    item.className = 'category-item';
    item.innerHTML = `
      <span class="category-name">üè∑Ô∏è ${cat.nome}</span>
      <div class="category-actions">
        <button class="btn-edit" onclick="editCategoria(${cat.id})">Editar</button>
        <button class="btn-delete" onclick="deleteCategoria(${cat.id})">Excluir</button>
      </div>
    `;
    customList.appendChild(item);
  });
}

function editCategoria(id) {
  const cat = categorias.find(c => c.id === id);
  document.getElementById('cat_id').value = cat.id;
  document.getElementById('cat_nome').value = cat.nome;
  
  document.getElementById('catFormTitle').textContent = 'Editar Categoria';
  document.getElementById('btnSaveCat').textContent = 'Salvar Altera√ß√µes';
  document.getElementById('btnCancelCat').style.display = 'inline-block';
}

function deleteCategoria(id) {
  if (confirm('Deseja realmente excluir esta categoria?')) {
    categorias = categorias.filter(c => c.id !== id);
    localStorage.setItem('categorias', JSON.stringify(categorias));
    renderCategorias();
    updateCategorySelects();
  }
}

function resetCatForm() {
  document.getElementById('cat_id').value = '';
  document.getElementById('cat_nome').value = '';
  document.getElementById('catFormTitle').textContent = 'Nova Categoria';
  document.getElementById('btnSaveCat').textContent = 'Adicionar Categoria';
  document.getElementById('btnCancelCat').style.display = 'none';
}

function updateCategorySelects() {
  // Atualizar select de categorias no financeiro
  const selectFin = document.getElementById('f_cat');
  selectFin.innerHTML = '';
  
  [...categoriasDefault, ...categorias.map(c => c.nome)].forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    selectFin.appendChild(option);
  });
  
  // Atualizar select de or√ßamento
  const selectOrc = document.getElementById('orc_categoria');
  selectOrc.innerHTML = '<option value="">Selecione...</option>';
  
  [...categoriasDefault, ...categorias.map(c => c.nome)].forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    selectOrc.appendChild(option);
  });
}

// ==================== METAS FINANCEIRAS ====================
function saveMeta() {
  const id = document.getElementById('meta_id').value;
  const item = {
    id: id ? parseInt(id) : Date.now(),
    titulo: document.getElementById('meta_titulo').value,
    valorObjetivo: parseCurrency(document.getElementById('meta_valor').value),
    valorAtual: parseCurrency(document.getElementById('meta_atual').value),
    prazo: document.getElementById('meta_prazo').value,
    descricao: document.getElementById('meta_desc').value,
    criacao: id ? metas.find(m => m.id === parseInt(id)).criacao : new Date().toISOString()
  };
  
  if (!item.titulo || item.valorObjetivo === 0) {
    alert('Preencha os campos obrigat√≥rios!');
    return;
  }
  
  if (id) {
    const index = metas.findIndex(m => m.id === item.id);
    metas[index] = item;
  } else {
    metas.push(item);
  }
  
  localStorage.setItem('metas', JSON.stringify(metas));
  resetMetaForm();
  renderMetas();
}

function renderMetas() {
  const container = document.getElementById('metasList');
  container.innerHTML = '';
  
  if (metas.length === 0) {
    container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Nenhuma meta definida ainda</p>';
    return;
  }
  
  metas.forEach(meta => {
    const progresso = (meta.valorAtual / meta.valorObjetivo) * 100;
    const isCompleta = progresso >= 100;
    
    const card = document.createElement('div');
    card.className = 'goal-card';
    
    let prazoInfo = '';
    if (meta.prazo) {
      const prazoDate = new Date(meta.prazo);
      const hoje = new Date();
      const diasRestantes = Math.ceil((prazoDate - hoje) / (1000 * 60 * 60 * 24));
      prazoInfo = diasRestantes > 0 ? `${diasRestantes} dias restantes` : 'Prazo vencido';
    }
    
    card.innerHTML = `
      <div class="goal-header">
        <h4 class="goal-title">${meta.titulo}</h4>
        <span class="goal-status ${isCompleta ? 'completed' : 'active'}">
          ${isCompleta ? '‚úì Conclu√≠da' : 'Em Andamento'}
        </span>
      </div>
      
      ${meta.descricao ? `<p style="color: #666; margin-bottom: 15px;">${meta.descricao}</p>` : ''}
      
      <div class="goal-progress-bar">
        <div class="goal-progress-fill" style="width: ${Math.min(progresso, 100)}%">
          ${progresso.toFixed(0)}%
        </div>
      </div>
      
      <div class="goal-info">
        <span>R$ ${displayCurrency(meta.valorAtual)} / R$ ${displayCurrency(meta.valorObjetivo)}</span>
        <span>${prazoInfo}</span>
      </div>
      
      <div class="action-buttons" style="margin-top: 15px;">
        <button class="btn-success" onclick="atualizarMeta(${meta.id})">Adicionar Valor</button>
        <button class="btn-edit" onclick="editMeta(${meta.id})">Editar</button>
        <button class="btn-delete" onclick="deleteMeta(${meta.id})">Excluir</button>
      </div>
    `;
    
    container.appendChild(card);
  });
}

function atualizarMeta(id) {
  const valor = prompt('Quanto deseja adicionar √† meta? (em R$)');
  if (!valor) return;
  
  const valorNum = parseCurrency(valor);
  if (valorNum <= 0) {
    alert('Valor inv√°lido!');
    return;
  }
  
  const meta = metas.find(m => m.id === id);
  meta.valorAtual += valorNum;
  
  localStorage.setItem('metas', JSON.stringify(metas));
  renderMetas();
  
  if (meta.valorAtual >= meta.valorObjetivo) {
    alert('üéâ Parab√©ns! Voc√™ atingiu sua meta!');
  }
}

function editMeta(id) {
  const meta = metas.find(m => m.id === id);
  document.getElementById('meta_id').value = meta.id;
  document.getElementById('meta_titulo').value = meta.titulo;
  document.getElementById('meta_valor').value = displayCurrency(meta.valorObjetivo);
  document.getElementById('meta_atual').value = displayCurrency(meta.valorAtual);
  document.getElementById('meta_prazo').value = meta.prazo || '';
  document.getElementById('meta_desc').value = meta.descricao || '';
  
  document.getElementById('metaFormTitle').textContent = 'Editar Meta';
  document.getElementById('btnSaveMeta').textContent = 'Salvar Altera√ß√µes';
  document.getElementById('btnCancelMeta').style.display = 'inline-block';
  
  document.getElementById('formMeta').scrollIntoView({behavior: 'smooth'});
}

function deleteMeta(id) {
  if (confirm('Deseja realmente excluir esta meta?')) {
    metas = metas.filter(m => m.id !== id);
    localStorage.setItem('metas', JSON.stringify(metas));
    renderMetas();
  }
}

function resetMetaForm() {
  document.getElementById('meta_id').value = '';
  document.getElementById('meta_titulo').value = '';
  document.getElementById('meta_valor').value = '';
  document.getElementById('meta_atual').value = '';
  document.getElementById('meta_prazo').value = '';
  document.getElementById('meta_desc').value = '';
  document.getElementById('metaFormTitle').textContent = 'Nova Meta Financeira';
  document.getElementById('btnSaveMeta').textContent = 'Criar Meta';
  document.getElementById('btnCancelMeta').style.display = 'none';
}

// ==================== OR√áAMENTO POR CATEGORIA ====================
function saveOrcamento() {
  const categoria = document.getElementById('orc_categoria').value;
  const limite = parseCurrency(document.getElementById('orc_limite').value);
  const mes = document.getElementById('orc_mes').value;
  
  if (!categoria || limite === 0 || !mes) {
    alert('Preencha todos os campos!');
    return;
  }
  
  const item = {
    id: Date.now(),
    categoria: categoria,
    limite: limite,
    mes: mes
  };
  
  orcamentos.push(item);
  localStorage.setItem('orcamentos', JSON.stringify(orcamentos));
  
  document.getElementById('orc_categoria').value = '';
  document.getElementById('orc_limite').value = '';
  
  renderOrcamentos();
  alert('Or√ßamento definido com sucesso!');
}

function renderOrcamentos() {
  const container = document.getElementById('orcamentosList');
  container.innerHTML = '';
  
  // Pegar m√™s atual
  const hoje = new Date();
  const mesAtual = `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, '0')}`;
  
  const orcsMesAtual = orcamentos.filter(o => o.mes === mesAtual);
  
  if (orcsMesAtual.length === 0) {
    container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Nenhum or√ßamento definido para este m√™s</p>';
    return;
  }
  
  orcsMesAtual.forEach(orc => {
    // Calcular gastos da categoria no m√™s
    const [ano, mes] = orc.mes.split('-');
    const gastos = financeiro.filter(item => {
      const itemDate = new Date(item.data);
      return item.categoria === orc.categoria &&
             itemDate.getFullYear() === parseInt(ano) &&
             itemDate.getMonth() + 1 === parseInt(mes) &&
             (item.tipo === 'Pago' || item.tipo === 'Pagar');
    }).reduce((sum, item) => sum + item.valor, 0);
    
    const percentual = (gastos / orc.limite) * 100;
    let status = 'ok';
    let statusText = 'OK';
    
    if (percentual >= 100) {
      status = 'danger';
      statusText = 'Limite Excedido!';
    } else if (percentual >= 80) {
      status = 'warning';
      statusText = 'Aten√ß√£o!';
    }
    
    const card = document.createElement('div');
    card.className = 'budget-card';
    card.innerHTML = `
      <div class="budget-header">
        <span class="budget-category">${orc.categoria}</span>
        <span class="budget-status ${status}">${statusText}</span>
      </div>
      
      <div class="budget-bar">
        <div class="budget-fill ${status}" style="width: ${Math.min(percentual, 100)}%"></div>
      </div>
      
      <div class="budget-values">
        <span>Gasto: R$ ${displayCurrency(gastos)}</span>
        <span>Limite: R$ ${displayCurrency(orc.limite)}</span>
      </div>
      
      <div class="action-buttons" style="margin-top: 10px;">
        <button class="btn-delete" onclick="deleteOrcamento(${orc.id})">Remover Or√ßamento</button>
      </div>
    `;
    
    container.appendChild(card);
  });
}

function deleteOrcamento(id) {
  if (confirm('Deseja remover este or√ßamento?')) {
    orcamentos = orcamentos.filter(o => o.id !== id);
    localStorage.setItem('orcamentos', JSON.stringify(orcamentos));
    renderOrcamentos();
  }
}

// ==================== PROJE√á√ÉO DE ATIVOS ====================

// Rentabilidades anuais m√©dias por modalidade (%)
const rentabilidadesPorModalidade = {
  'A√ß√µes': 12.5,           // Ibovespa hist√≥rico
  'FIIs': 9.0,             // FIIs hist√≥rico
  'Renda Fixa': 10.5,      // CDI m√©dio
  'CDB': 10.0,             // CDI
  'Tesouro Direto': 10.5,  // IPCA + Taxa
  'Criptomoedas': 50.0,    // Muito vol√°til - use com cautela
  'Fundos': 8.5,           // Fundos conservadores
  'Outros': 8.0            // Conservador
};

let currentProjectionPeriod = 12;
let currentProjectionUnit = 'meses';
let projectionChartInstance = null;

function selectProjectionPeriod(period, unit) {
  currentProjectionPeriod = period;
  currentProjectionUnit = unit;
  
  // Atualizar bot√µes ativos
  document.querySelectorAll('.projection-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Calcular proje√ß√£o
  calculateProjections();
}

function applyCustomProjection() {
  const customPeriod = parseInt(document.getElementById('customPeriod').value);
  const customUnit = document.getElementById('customUnit').value;
  
  if (!customPeriod || customPeriod < 1) {
    alert('Digite um per√≠odo v√°lido!');
    return;
  }
  
  currentProjectionPeriod = customPeriod;
  currentProjectionUnit = customUnit;
  
  // Remover sele√ß√£o dos bot√µes
  document.querySelectorAll('.projection-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  calculateProjections();
}

function calculateProjections() {
  const container = document.getElementById('projectionResultsContainer');
  container.innerHTML = '<h3 style="color: #333; margin: 20px 0;">Proje√ß√µes por Modalidade</h3>';
  
  // Calcular per√≠odo em meses
  const meses = currentProjectionUnit === 'anos' 
    ? currentProjectionPeriod * 12 
    : currentProjectionPeriod;
  
  // Agrupar investimentos por modalidade
  const investimentosPorModalidade = {};
  
  investimentos.forEach(inv => {
    if (!investimentosPorModalidade[inv.modalidade]) {
      investimentosPorModalidade[inv.modalidade] = {
        total: 0,
        itens: []
      };
    }
    investimentosPorModalidade[inv.modalidade].total += inv.valor;
    investimentosPorModalidade[inv.modalidade].itens.push(inv);
  });
  
  // Container de cards
  const resultsDiv = document.createElement('div');
  resultsDiv.className = 'projection-results';
  
  let totalAtual = 0;
  let totalProjetado = 0;
  const chartData = {
    labels: [],
    atual: [],
    projetado: []
  };
  
  // Criar card para cada modalidade
  Object.keys(investimentosPorModalidade).sort().forEach(modalidade => {
    const data = investimentosPorModalidade[modalidade];
    const rentabilidadeAnual = rentabilidadesPorModalidade[modalidade] || 8.0;
    
    // C√°lculo com juros compostos
    const rentabilidadeMensal = Math.pow(1 + rentabilidadeAnual / 100, 1/12) - 1;
    const valorProjetado = data.total * Math.pow(1 + rentabilidadeMensal, meses);
    const ganho = valorProjetado - data.total;
    const percentualGanho = ((ganho / data.total) * 100);
    
    totalAtual += data.total;
    totalProjetado += valorProjetado;
    
    // Dados para gr√°fico
    chartData.labels.push(modalidade);
    chartData.atual.push(data.total);
    chartData.projetado.push(valorProjetado);
    
    const card = document.createElement('div');
    card.className = 'projection-card';
    card.innerHTML = `
      <h4>üìä ${modalidade}</h4>
      
      <div class="current-value">
        Valor Atual: <strong>R$ ${displayCurrency(data.total)}</strong>
      </div>
      
      <div class="projected-value">
        R$ ${displayCurrency(valorProjetado)}
      </div>
      
      <div class="gain">
        <span>‚ÜóÔ∏è</span>
        <span>+R$ ${displayCurrency(ganho)} (+${percentualGanho.toFixed(2)}%)</span>
      </div>
      
      <div class="details">
        <div>
          <span>Rentabilidade Anual:</span>
          <strong>${rentabilidadeAnual.toFixed(2)}% a.a.</strong>
        </div>
        <div>
          <span>Per√≠odo:</span>
          <strong>${currentProjectionPeriod} ${currentProjectionUnit}</strong>
        </div>
        <div>
          <span>Ativos:</span>
          <strong>${data.itens.length}</strong>
        </div>
      </div>
    `;
    
    resultsDiv.appendChild(card);
  });
  
  container.appendChild(resultsDiv);
  
  // Card de resumo total
  const totalGanho = totalProjetado - totalAtual;
  const percentualTotal = ((totalGanho / totalAtual) * 100);
  
  const summaryDiv = document.createElement('div');
  summaryDiv.className = 'projection-summary';
  summaryDiv.innerHTML = `
    <h3>üí∞ Resumo Total da Proje√ß√£o</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
      <div>
        <div style="opacity: 0.8; font-size: 14px;">Investido Hoje</div>
        <div style="font-size: 32px; font-weight: 700;">R$ ${displayCurrency(totalAtual)}</div>
      </div>
      <div>
        <div style="opacity: 0.8; font-size: 14px;">Proje√ß√£o em ${currentProjectionPeriod} ${currentProjectionUnit}</div>
        <div class="total-projected">R$ ${displayCurrency(totalProjetado)}</div>
      </div>
    </div>
    <div class="total-gain">
      <div style="opacity: 0.8; font-size: 16px; margin-bottom: 10px;">Ganho Projetado</div>
      <div>+R$ ${displayCurrency(totalGanho)} (+${percentualTotal.toFixed(2)}%)</div>
    </div>
  `;
  
  container.appendChild(summaryDiv);
  
  // Mostrar e renderizar gr√°fico
  if (Object.keys(investimentosPorModalidade).length > 0) {
    document.getElementById('projectionChartContainer').style.display = 'block';
    renderProjectionChart(chartData);
  }
}

function renderProjectionChart(data) {
  const ctx = document.getElementById('projectionChart');
  
  if (projectionChartInstance) {
    projectionChartInstance.destroy();
  }
  
  projectionChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.labels,
      datasets: [
        {
          label: 'Valor Atual',
          data: data.atual,
          backgroundColor: 'rgba(102, 126, 234, 0.8)',
          borderColor: 'rgba(102, 126, 234, 1)',
          borderWidth: 2
        },
        {
          label: `Proje√ß√£o (${currentProjectionPeriod} ${currentProjectionUnit})`,
          data: data.projetado,
          backgroundColor: 'rgba(40, 167, 69, 0.8)',
          borderColor: 'rgba(40, 167, 69, 1)',
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'Compara√ß√£o: Valor Atual vs Proje√ß√£o Futura',
          font: {
            size: 16
          }
        },
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': R$ ' + displayCurrency(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'R$ ' + displayCurrency(value);
            }
          }
        }
      }
    }
  });
}

// ==================== FUN√á√ïES DE FECHAMENTO MENSAL ====================
function visualizarMes() {
  const mesAno = document.getElementById('fechamento_mes').value;
  
  if (!mesAno) {
    alert('Selecione um m√™s!');
    return;
  }
  
  mesSelecionado = mesAno;
  const totais = calcularTotaisMes(mesAno);
  
  // Atualizar cards
  document.getElementById('fech_receitas').textContent = 'R$ ' + displayCurrency(totais.receitas);
  document.getElementById('fech_despesas').textContent = 'R$ ' + displayCurrency(totais.despesas);
  
  const saldoEl = document.getElementById('fech_saldo');
  saldoEl.textContent = 'R$ ' + displayCurrency(Math.abs(totais.saldo));
  saldoEl.style.color = totais.saldo >= 0 ? '#28a745' : '#e74c3c';
  
  document.getElementById('fech_num_trans').textContent = totais.transacoes.length;
  
  // Renderizar tabela
  const tbody = document.querySelector('#tabelaTransacoesMes tbody');
  tbody.innerHTML = '';
  
  totais.transacoes.forEach(item => {
    const row = tbody.insertRow();
    const dataFormatada = new Date(item.data).toLocaleDateString('pt-BR');
    
    let badgeColor = item.tipo.includes('Receb') ? '#d4edda' : '#f8d7da';
    let textColor = item.tipo.includes('Receb') ? '#155724' : '#721c24';
    
    row.innerHTML = `
      <td>${dataFormatada}</td>
      <td><span style="padding: 4px 8px; border-radius: 4px; background: ${badgeColor}; color: ${textColor};">${item.tipo}</span></td>
      <td>${item.descricao}</td>
      <td>${item.categoria}</td>
      <td><strong>R$ ${displayCurrency(item.valorCalculado)}</strong></td>
    `;
  });
  
  // Mostrar se√ß√£o
  document.getElementById('dadosMesSelecionado').style.display = 'block';
}

function fecharMesAtual() {
  const mesAno = document.getElementById('fechamento_mes').value;
  
  if (!mesAno) {
    alert('Selecione um m√™s primeiro!');
    return;
  }
  
  if (!confirm(`Deseja fechar o m√™s ${mesAno}?\n\nIsso ir√° salvar todos os dados deste m√™s como hist√≥rico.`)) {
    return;
  }
  
  const fechamento = fecharMes(mesAno);
  
  alert(`‚úÖ M√™s ${mesAno} fechado com sucesso!\n\nReceitas: R$ ${displayCurrency(fechamento.receitas)}\nDespesas: R$ ${displayCurrency(fechamento.despesas)}\nSaldo: R$ ${displayCurrency(fechamento.saldo)}`);
  
  renderHistoricoFechamentos();
}

function renderHistoricoFechamentos() {
  const container = document.getElementById('historicoFechamentos');
  container.innerHTML = '';
  
  if (fechamentosMensais.length === 0) {
    container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Nenhum m√™s foi fechado ainda</p>';
    return;
  }
  
  const fechamentosOrdenados = [...fechamentosMensais].sort((a, b) => b.mesAno.localeCompare(a.mesAno));
  
  fechamentosOrdenados.forEach(fech => {
    const card = document.createElement('div');
    card.className = 'budget-card';
    card.style.marginBottom = '15px';
    
    const dataFech = new Date(fech.dataFechamento).toLocaleString('pt-BR');
    
    card.innerHTML = `
      <div class="budget-header">
        <span class="budget-category">üìÖ ${fech.mesAno}</span>
        <span class="budget-status ${fech.saldo >= 0 ? 'ok' : 'danger'}">
          ${fech.saldo >= 0 ? 'Super√°vit' : 'D√©ficit'}
        </span>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0;">
        <div>
          <small style="color: #666;">Receitas</small>
          <div style="font-weight: 700; color: #28a745;">R$ ${displayCurrency(fech.receitas)}</div>
        </div>
        <div>
          <small style="color: #666;">Despesas</small>
          <div style="font-weight: 700; color: #e74c3c;">R$ ${displayCurrency(fech.despesas)}</div>
        </div>
        <div>
          <small style="color: #666;">Saldo</small>
          <div style="font-weight: 700; color: ${fech.saldo >= 0 ? '#28a745' : '#e74c3c'};">
            R$ ${displayCurrency(Math.abs(fech.saldo))}
          </div>
        </div>
      </div>
      
      <div style="font-size: 12px; color: #999; margin-top: 10px;">
        Fechado em: ${dataFech} | ${fech.numTransacoes} transa√ß√µes
      </div>
      
      <div class="action-buttons" style="margin-top: 10px;">
        <button class="btn-primary" onclick="visualizarFechamento('${fech.mesAno}')">Ver Detalhes</button>
        <button class="btn-export" onclick="exportarFechamentoPDF('${fech.mesAno}')">Exportar PDF</button>
        <button class="btn-delete" onclick="deleteFechamento('${fech.mesAno}')">Excluir</button>
      </div>
    `;
    
    container.appendChild(card);
  });
}

function visualizarFechamento(mesAno) {
  document.getElementById('fechamento_mes').value = mesAno;
  visualizarMes();
  document.getElementById('dadosMesSelecionado').scrollIntoView({behavior: 'smooth'});
}

function deleteFechamento(mesAno) {
  if (confirm(`Deseja realmente excluir o fechamento de ${mesAno}?\n\nOs dados das transa√ß√µes N√ÉO ser√£o exclu√≠dos, apenas o registro de fechamento.`)) {
    fechamentosMensais = fechamentosMensais.filter(f => f.mesAno !== mesAno);
    localStorage.setItem('fechamentosMensais', JSON.stringify(fechamentosMensais));
    renderHistoricoFechamentos();
    alert('Fechamento exclu√≠do!');
  }
}

function exportarFechamentoPDF(mesAno) {
  const fech = fechamentosMensais.find(f => f.mesAno === mesAno);
  
  if (!fech) {
    alert('Fechamento n√£o encontrado!');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  
  pdf.setFontSize(18);
  pdf.text(`Fechamento Mensal - ${mesAno}`, 10, 15);
  
  pdf.setFontSize(12);
  pdf.text(`Fechado em: ${new Date(fech.dataFechamento).toLocaleString('pt-BR')}`, 10, 25);
  
  pdf.setFontSize(14);
  pdf.text(`Receitas: R$ ${displayCurrency(fech.receitas)}`, 10, 40);
  pdf.text(`Despesas: R$ ${displayCurrency(fech.despesas)}`, 10, 50);
  pdf.text(`Saldo: R$ ${displayCurrency(fech.saldo)}`, 10, 60);
  pdf.text(`Transa√ß√µes: ${fech.numTransacoes}`, 10, 70);
  
  pdf.setFontSize(12);
  pdf.text('Detalhamento de Transa√ß√µes:', 10, 85);
  
  let y = 95;
  fech.transacoes.forEach((trans, index) => {
    if (y > 270) {
      pdf.addPage();
      y = 10;
    }
    
    pdf.text(`${index + 1}. ${trans.descricao} - ${trans.tipo}`, 10, y);
    y += 6;
    pdf.text(`   R$ ${displayCurrency(trans.valorCalculado)} - ${trans.categoria}`, 10, y);
    y += 10;
  });
  
  pdf.save(`fechamento-${mesAno}.pdf`);
  alert('PDF exportado com sucesso!');
}
</script>
<!-- BOT√ÉO DE ALTERN√ÇNCIA DE TEMA -->
<button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Alternar tema">
  üåô
</button>
</body>
</html>
